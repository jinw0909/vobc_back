<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<th:block th:replace="~{layout/head :: head}">
</th:block>
<style>
    #content figure > img { width: 33%; }
</style>

<body>
<th:block th:replace="~{layout/header :: header}"></th:block>
<div class="container mt-5" th:with="isNew=${post.id} == null">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 th:text="${isNew} ? 'ìƒˆ ê²Œì‹œê¸€ ì‘ì„±' : 'ê²Œì‹œê¸€ ìˆ˜ì •'"></h2>
        <a class="btn btn-outline-dark" th:href="@{/post/list}">ëª©ë¡</a>
    </div>

    <!-- ìƒˆ ê¸€ì´ë©´ /post/create, ìˆ˜ì •ì´ë©´ /post/update?id=... -->
<!--    <form th:action="${isNew} ? @{/post/create} : @{/post/update(id=${post.id})}" method="post">-->
    <form id="postForm" method="post" enctype="multipart/form-data">

        <input type="hidden" name="id" th:value="${post.id}">

        <div class="mb-3">
            <label for="title" class="form-label">ì œëª©</label>
            <input type="text"
                   id="title"
                   name="title"
                   class="form-control"
                   th:value="${post.title}"
                   required>
        </div>

        <div class="mb-3">
            <label for="summary" class="form-label">ìš”ì•½</label>
            <input type="text"
                   id="summary"
                   name="summary"
                   class="form-control"
                   th:value="${post.summary}">
        </div>

        <div class="mb-3">
            <label for="author" class="form-label">ì‘ì„±ì</label>
            <input type="text"
                   id="author"
                   name="author"
                   class="form-control"
                   th:value="${post.author}">
        </div>

        <!-- âœ… ë°œí–‰ì¼ ì…ë ¥ -->
        <div class="mb-3">
            <label for="releaseDate" class="form-label">ë°œí–‰ì¼</label>
            <input type="date"
                   id="releaseDate"
                   name="releaseDate"
                   class="form-control"
                   th:value="${post.releaseDate}">
        </div>

        <!-- âœ… ì¸ë„¤ì¼ URL + ì—…ë¡œë“œ ë²„íŠ¼ + ë¯¸ë¦¬ë³´ê¸° -->
        <div class="mb-3">
            <label for="thumbnail" class="form-label">ì¸ë„¤ì¼</label>

            <!-- URL ì…ë ¥ + ì—…ë¡œë“œ ë²„íŠ¼ -->
            <div class="input-group">
                <input type="text"
                       id="thumbnail"
                       name="thumbnail"
                       class="form-control"
                       placeholder="https://example.com/image.jpg"
                       th:value="${post.thumbnail}">
                <button type="button"
                        class="btn btn-outline-secondary"
                        id="btnUploadThumbnail">
                    ì´ë¯¸ì§€ ì—…ë¡œë“œ
                </button>
            </div>
            <small class="text-muted d-block mt-1">
                ì§ì ‘ URLì„ ë¶™ì—¬ë„£ê±°ë‚˜, ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ íŒŒì¼ì„ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </small>

            <!-- ì‹¤ì œ íŒŒì¼ ì„ íƒ input (ìˆ¨ê¹€) -->
            <input type="file"
                   id="thumbnailFile"
                   accept="image/*"
                   style="display:none;">

            <!-- ë¯¸ë¦¬ë³´ê¸° -->
            <div class="mt-2"
                 th:if="${post.thumbnail != null and !#strings.isEmpty(post.thumbnail)}">
                <img th:src="${post.thumbnail}"
                     id="thumbnailPreview"
                     alt="ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°"
                     class="img-thumbnail"
                     style="max-height: 150px;">
            </div>
            <!-- ìƒˆ ê¸€ì¼ ë•Œë„ JSë¡œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì“°ê³  ì‹¶ìœ¼ë©´, ì•„ë˜ì²˜ëŸ¼ ë¹ˆ imgë¥¼ í•˜ë‚˜ ë‘¬ë„ ë¨
            <div class="mt-2" th:unless="${post.thumbnail != null and !#strings.isEmpty(post.thumbnail)}">
                <img id="thumbnailPreview"
                     alt="ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°"
                     class="img-thumbnail"
                     style="max-height: 150px; display:none;">
            </div>
            -->
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">ë‚´ìš©</label>
            <textarea id="content"
                      name="content"
                      rows="12"
                      class="form-control"
                      data-summernote
                      th:text="${post.content}"></textarea>
        </div>

        <!-- íƒœê·¸ ì„ íƒ ì˜ì—­ (priority ìˆ«ìëŠ” ì—¬ê¸°ì„  ì•ˆ ë‹¤ë£¸) -->
        <div class="mb-4">
            <label class="form-label">íƒœê·¸</label>
            <div class="border rounded p-2" style="max-height: 220px; overflow-y: auto;">
                <div class="form-check"
                     th:each="tag : ${allTags}">

                    <input class="form-check-input"
                           type="checkbox"
                           name="tagIds"
                           th:id="${'tag-' + tag.id}"
                           th:value="${tag.id}"
                           th:checked="${postTagByTagId != null and postTagByTagId.containsKey(tag.id)}"
                           th:attr="
                              data-post-id=${post.id},
                              data-post-tag-id=${postTagByTagId != null && postTagByTagId.containsKey(tag.id) ? postTagByTagId.get(tag.id).postTagId : ''},
                              data-sort-order=${postTagByTagId != null && postTagByTagId.containsKey(tag.id) ? postTagByTagId.get(tag.id).sortOrder : ''},
                              data-primary-tag=${postTagByTagId != null && postTagByTagId.containsKey(tag.id) ? postTagByTagId.get(tag.id).primaryTag : ''}
                           ">
                    <label class="form-check-label"
                           th:for="${'tag-' + tag.id}"
                           th:text="${tag.name}"></label>
                </div>

                <div th:if="${#lists.isEmpty(allTags)}" class="text-muted">
                    ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íƒœê·¸ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.
                </div>
            </div>
            <small class="text-muted d-block mt-1">
                â€» íƒœê·¸ ìš°ì„ ìˆœìœ„(ë…¸ì¶œ ìˆœì„œ)ëŠ” ìƒì„¸ í™”ë©´ì—ì„œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </small>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <a class="btn btn-outline-secondary" th:href="@{/post/list}">ì·¨ì†Œ</a>
            <button type="button" class="btn btn-primary" id="btnSave"
                    th:text="${isNew} ? 'ì‘ì„±í•˜ê¸°' : 'ìˆ˜ì •í•˜ê¸°'"></button>
        </div>
    </form>
</div>

<div th:replace="~{layout/footer :: footer}"></div>

<!-- âœ… ì¸ë„¤ì¼ ì—…ë¡œë“œ JS -->
<script th:inline="javascript">
    const uploadBtn = document.getElementById('btnUploadThumbnail');
    const fileInput = document.getElementById('thumbnailFile');
    const thumbnailInput = document.getElementById('thumbnail');
    const previewImg = document.getElementById('thumbnailPreview');

    if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            uploadBtn.disabled = true;
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';

            try {
                const response = await fetch('/api/upload/thumbnail', {
                    method: 'POST',
                    body: formData
                    // ğŸ” CSRFë¥¼ ì“°ê³  ìˆìœ¼ë©´ ì—¬ê¸°ì„œ í—¤ë” ì¶”ê°€ í•„ìš”
                    // headers: { 'X-CSRF-TOKEN': token }
                });

                if (!response.ok) {
                    throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                const url = data.url;  // { "url": "https://..." } í˜•íƒœë¼ê³  ê°€ì •

                // ì¸í’‹ì— ìë™ ì„¸íŒ…
                thumbnailInput.value = url;

                // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
                if (previewImg) {
                    previewImg.src = url;
                    previewImg.style.display = 'block';
                } else {
                    // ìœ„ì—ì„œ ë¹ˆ imgë¥¼ ë‘ì§€ ì•Šì•˜ë‹¤ë©´, ë™ì ìœ¼ë¡œ ë§Œë“¤ì–´ë„ ë¨
                    const img = document.createElement('img');
                    img.id = 'thumbnailPreview';
                    img.src = url;
                    img.alt = 'ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°';
                    img.className = 'img-thumbnail mt-2';
                    img.style.maxHeight = '150px';
                    uploadBtn.closest('.mb-3').appendChild(img);
                }

            } catch (e) {
                console.error(e);
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
                fileInput.value = '';
            }
        });
    }

    const initial = thumbnailInput?.value?.trim();
    if (initial && previewImg) {
        previewImg.src = initial;
        previewImg.style.display = 'block';
    }

</script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        // âœ… app.jsê°€ [data-summernote] ìë™ init í•œë‹¤ë©´ ì—¬ê¸° í˜¸ì¶œ ì œê±°
        // initiateSummernote();

        const formEl = document.getElementById('postForm');
        const btnSave = document.getElementById('btnSave');

        btnSave?.addEventListener('click', async () => {
            const formData = new FormData(formEl);

            const payload = window.getSummernotePayload({
                editorSelector: '#content'
            });

            formData.set('content', payload.content);

            // âœ… filesëŠ” 1ë²ˆë§Œ append
            for (const f of payload.files) formData.append('files', f);

            fillPostTagsToFormData(formData);

            btnSave.disabled = true;
            const originalText = btnSave.textContent;
            btnSave.textContent = 'ì €ì¥ ì¤‘...';

            try {
                const res = await fetch('/post/save', { method: 'POST', body: formData });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                window.location.href = `/post/detail?id=${data.id}`;
            } catch (e) {
                console.error(e);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + (e.message ?? e));
            } finally {
                btnSave.disabled = false;
                btnSave.textContent = originalText;
            }
        });
    });
    function fillPostTagsToFormData(formData) {
        formData.delete('tagIds'); // ì²´í¬ë°•ìŠ¤ ê°’ì€ ì´ì œ ì•ˆ ì“°ê³ , postTagsë¡œ ë³´ë‚¼ê±°ë¼ ì œê±°

        const checked = Array.from(document.querySelectorAll('input[name="tagIds"]:checked'));

        // sortOrder ì •ì±…:
        // - ìˆ˜ì • í™”ë©´: data-sort-order ìˆìœ¼ë©´ ê·¸ ê°’ ì‚¬ìš©
        // - ì—†ìœ¼ë©´ ì²´í¬ëœ ìˆœì„œëŒ€ë¡œ 1..N
        checked.forEach((cb, idx) => {
            const tagId = (cb.value || '').trim();

            const postId = (cb.dataset.postId || document.querySelector('input[name="id"]')?.value || '').trim();
            const postTagId = (cb.dataset.postTagId || '').trim();
            const sortOrder = (cb.dataset.sortOrder || (idx + 1)).toString().trim();
            const primaryTag = (cb.dataset.primaryTag || 'false').toString().trim();

            const base = `postTags[${idx}]`;

            // âœ… PostTagForm í¬ë§· ê·¸ëŒ€ë¡œ ì±„ì›Œì„œ ë³´ëƒ„ (ë¹ˆ ê°’ë„ í¬í•¨)
            formData.append(`${base}.postTagId`, postTagId);
            formData.append(`${base}.postId`, postId);
            formData.append(`${base}.tagId`, tagId);
            formData.append(`${base}.sortOrder`, sortOrder);
            formData.append(`${base}.primaryTag`, primaryTag);
        });
    }

</script>



</body>
</html>
