<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{layout/head :: head}"></head>
<body>

<div class="container mt-5" th:with="isNew=${post.id} == null">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 th:text="${isNew} ? 'ìƒˆ ê²Œì‹œê¸€ ì‘ì„±' : 'ê²Œì‹œê¸€ ìˆ˜ì •'"></h2>
        <a class="btn btn-outline-dark" th:href="@{/post/list}">ëª©ë¡</a>
    </div>

    <!-- ìƒˆ ê¸€ì´ë©´ /post/create, ìˆ˜ì •ì´ë©´ /post/update?id=... -->
    <form th:action="${isNew} ? @{/post/create} : @{/post/update(id=${post.id})}"
          method="post">

        <div class="mb-3">
            <label for="title" class="form-label">ì œëª©</label>
            <input type="text"
                   id="title"
                   name="title"
                   class="form-control"
                   th:value="${post.title}"
                   required>
        </div>

        <div class="mb-3">
            <label for="summary" class="form-label">ìš”ì•½</label>
            <input type="text"
                   id="summary"
                   name="summary"
                   class="form-control"
                   th:value="${post.summary}">
        </div>

        <div class="mb-3">
            <label for="author" class="form-label">ì‘ì„±ì</label>
            <input type="text"
                   id="author"
                   name="author"
                   class="form-control"
                   th:value="${post.author}">
        </div>

        <!-- âœ… ë°œí–‰ì¼ ì…ë ¥ -->
        <div class="mb-3">
            <label for="releaseDate" class="form-label">ë°œí–‰ì¼</label>
            <input type="date"
                   id="releaseDate"
                   name="releaseDate"
                   class="form-control"
                   th:value="${post.releaseDate}">
        </div>

        <!-- âœ… ì¸ë„¤ì¼ URL + ì—…ë¡œë“œ ë²„íŠ¼ + ë¯¸ë¦¬ë³´ê¸° -->
        <div class="mb-3">
            <label for="thumbnail" class="form-label">ì¸ë„¤ì¼</label>

            <!-- URL ì…ë ¥ + ì—…ë¡œë“œ ë²„íŠ¼ -->
            <div class="input-group">
                <input type="text"
                       id="thumbnail"
                       name="thumbnail"
                       class="form-control"
                       placeholder="https://example.com/image.jpg"
                       th:value="${post.thumbnail}">
                <button type="button"
                        class="btn btn-outline-secondary"
                        id="btnUploadThumbnail">
                    ì´ë¯¸ì§€ ì—…ë¡œë“œ
                </button>
            </div>
            <small class="text-muted d-block mt-1">
                ì§ì ‘ URLì„ ë¶™ì—¬ë„£ê±°ë‚˜, ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ íŒŒì¼ì„ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </small>

            <!-- ì‹¤ì œ íŒŒì¼ ì„ íƒ input (ìˆ¨ê¹€) -->
            <input type="file"
                   id="thumbnailFile"
                   accept="image/*"
                   style="display:none;">

            <!-- ë¯¸ë¦¬ë³´ê¸° -->
            <div class="mt-2"
                 th:if="${post.thumbnail != null and !#strings.isEmpty(post.thumbnail)}">
                <img th:src="${post.thumbnail}"
                     id="thumbnailPreview"
                     alt="ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°"
                     class="img-thumbnail"
                     style="max-height: 150px;">
            </div>
            <!-- ìƒˆ ê¸€ì¼ ë•Œë„ JSë¡œ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì“°ê³  ì‹¶ìœ¼ë©´, ì•„ë˜ì²˜ëŸ¼ ë¹ˆ imgë¥¼ í•˜ë‚˜ ë‘¬ë„ ë¨
            <div class="mt-2" th:unless="${post.thumbnail != null and !#strings.isEmpty(post.thumbnail)}">
                <img id="thumbnailPreview"
                     alt="ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°"
                     class="img-thumbnail"
                     style="max-height: 150px; display:none;">
            </div>
            -->
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">ë‚´ìš©</label>
            <textarea id="content"
                      name="content"
                      rows="12"
                      class="form-control"
                      th:text="${post.content}"></textarea>
        </div>

        <!-- íƒœê·¸ ì„ íƒ ì˜ì—­ (priority ìˆ«ìëŠ” ì—¬ê¸°ì„  ì•ˆ ë‹¤ë£¸) -->
        <div class="mb-4">
            <label class="form-label">íƒœê·¸</label>
            <div class="border rounded p-2" style="max-height: 220px; overflow-y: auto;">
                <div class="form-check"
                     th:each="tag : ${allTags}">
                    <input class="form-check-input"
                           type="checkbox"
                           name="tagIds"
                           th:id="${'tag-' + tag.id}"
                           th:value="${tag.id}"
                           th:checked="${
                               post != null and
                               #lists.contains(post.postTags.![tag.id], tag.id)
                           }">
                    <label class="form-check-label"
                           th:for="${'tag-' + tag.id}"
                           th:text="${tag.name}"></label>
                </div>

                <div th:if="${#lists.isEmpty(allTags)}" class="text-muted">
                    ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íƒœê·¸ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.
                </div>
            </div>
            <small class="text-muted d-block mt-1">
                â€» íƒœê·¸ ìš°ì„ ìˆœìœ„(ë…¸ì¶œ ìˆœì„œ)ëŠ” ìƒì„¸ í™”ë©´ì—ì„œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </small>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <a class="btn btn-outline-secondary" th:href="@{/post/list}">ì·¨ì†Œ</a>
            <button type="submit" class="btn btn-primary"
                    th:text="${isNew} ? 'ì‘ì„±í•˜ê¸°' : 'ìˆ˜ì •í•˜ê¸°'"></button>
        </div>
    </form>
</div>

<div th:replace="~{layout/footer :: footer}"></div>

<!-- âœ… ì¸ë„¤ì¼ ì—…ë¡œë“œ JS -->
<script th:inline="javascript">
    const uploadBtn = document.getElementById('btnUploadThumbnail');
    const fileInput = document.getElementById('thumbnailFile');
    const thumbnailInput = document.getElementById('thumbnail');
    const previewImg = document.getElementById('thumbnailPreview');

    if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            uploadBtn.disabled = true;
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';

            try {
                const response = await fetch('/api/upload/thumbnail', {
                    method: 'POST',
                    body: formData
                    // ğŸ” CSRFë¥¼ ì“°ê³  ìˆìœ¼ë©´ ì—¬ê¸°ì„œ í—¤ë” ì¶”ê°€ í•„ìš”
                    // headers: { 'X-CSRF-TOKEN': token }
                });

                if (!response.ok) {
                    throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                const url = data.url;  // { "url": "https://..." } í˜•íƒœë¼ê³  ê°€ì •

                // ì¸í’‹ì— ìë™ ì„¸íŒ…
                thumbnailInput.value = url;

                // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
                if (previewImg) {
                    previewImg.src = url;
                    previewImg.style.display = 'block';
                } else {
                    // ìœ„ì—ì„œ ë¹ˆ imgë¥¼ ë‘ì§€ ì•Šì•˜ë‹¤ë©´, ë™ì ìœ¼ë¡œ ë§Œë“¤ì–´ë„ ë¨
                    const img = document.createElement('img');
                    img.id = 'thumbnailPreview';
                    img.src = url;
                    img.alt = 'ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°';
                    img.className = 'img-thumbnail mt-2';
                    img.style.maxHeight = '150px';
                    uploadBtn.closest('.mb-3').appendChild(img);
                }

            } catch (e) {
                console.error(e);
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
                fileInput.value = '';
            }
        });
    }
</script>

</body>
</html>
