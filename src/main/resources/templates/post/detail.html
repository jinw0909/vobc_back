<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head th:replace="~{layout/head :: head}"></head>
<body>
<style>
    .content-scroll-box {
        max-height: 480px;
        overflow-y: auto;
        overflow-x: hidden;
    }
    .content-scroll-box img {
        display: block;
        max-width: 100%;
        height: auto;
        margin: 1rem auto;
        width: 100%;
    }
    .content-scroll-box p {
        margin-bottom: 1rem;
        /*line-height: 1.7;*/
    }
    .content-scroll-box h4,
    .content-scroll-box h5,
    .content-scroll-box h6 {
        margin-top: 1.8rem;
        margin-bottom: 0.8rem;
    }

    .content-scroll-box ul {
        /*margin-left: 1.2rem;*/
        margin-bottom: 1.2rem;
    }
</style>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 th:text="${post.title}">게시글 제목</h2>
        <div>

            <!-- 번역 버튼 그룹 -->
            <div class="btn-group me-2" role="group" aria-label="Translate">
                <a class="btn btn-sm btn-outline-primary"
                   th:classappend="${langs.contains('kr')}  ? ' btn-primary text-white' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='kr')}">
                    KR
                </a>
                <a class="btn btn-sm btn-outline-primary"
                   th:classappend="${langs.contains('jp')} ? ' btn-primary text-white' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='jp')}">
                    JP
                </a>
                <a class="btn btn-sm btn-outline-primary"
                   th:classappend="${langs.contains('cn')} ? ' btn-primary text-white' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='cn')}">
                    CN
                </a>
                <a class="btn btn-sm btn-outline-primary"
                   th:classappend="${langs.contains('en')} ? ' btn-primary text-white' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='en')}">
                    EN
                </a>
            </div>

            <a class="btn btn-outline-secondary me-2"
               th:href="@{/post/update(id=${post.id})}">수정</a>
            <a class="btn btn-outline-dark"
               th:href="@{/post/list}">목록</a>
        </div>
    </div>

    <!-- 메타 정보 영역 -->
    <div class="mb-3 text-muted">
        <span th:text="'작성자: ' + ${post.author}"></span>
<!--        <span class="ms-3"-->
<!--              th:text="'작성일: ' + ${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span>-->
        <!-- ✅ 발행일 (releaseDate) 표시 -->
        <span class="ms-3"
              th:if="${post.releaseDate != null}"
              th:text="'발행일: ' + ${#temporals.format(post.releaseDate, 'yyyy-MM-dd')}"></span>
    </div>

    <!-- ✅ 썸네일 영역 -->
    <div class="mb-3"
         th:if="${post.thumbnail != null and !#strings.isEmpty(post.thumbnail)}">
        <strong>썸네일</strong>
        <div class="mt-2">
            <img th:src="${post.thumbnail}"
                 alt="썸네일"
                 class="img-thumbnail mb-1"
                 style="max-height: 200px;">
            <div class="small text-muted text-truncate"
                 th:text="${post.thumbnail}"></div>
        </div>
    </div>

    <div class="mb-3">
        <strong>요약</strong>
        <p class="form-control-plaintext border rounded p-3 content-scroll-box" th:text="${post.summary} ?: '요약 없음'"></p>
    </div>

    <div class="mb-4">
        <strong>내용</strong>
        <!-- content 가 HTML이면 th:utext, 순수 텍스트면 th:text -->
        <div class="border rounded p-3 content-scroll-box" th:utext="${post.content}"></div>
    </div>

    <!-- 태그 섹션 -->
    <div class="mb-4">
        <div class="d-flex align-items-center">
            <strong>태그</strong>
            <button type="button"
                    class="btn btn-sm btn-outline-primary ms-2"
                    onclick="toggleTagEditor()">
                태그 수정
            </button>
        </div>

        <!-- 현재 태그 뱃지 표시 영역 -->
        <div class="mt-2" id="tagDisplay">
            <a th:each="pt : ${post.postTags}"
               th:href="@{/tag/posts(id=${pt.tag.id})}"
               class="badge text-bg-secondary me-1 text-decoration-none"
               th:text="${pt.tag.name}">
            </a>
            <span th:if="${#lists.isEmpty(post.postTags)}" class="text-muted">
                등록된 태그가 없습니다.
            </span>
        </div>

        <!-- 인라인 태그 편집 패널 -->
        <div id="tagEditorPanel" class="mt-3 border rounded p-3" style="display: none;">

            <!-- 태그 리스트 테이블 -->
            <table class="table align-middle" id="tagEditTable">
                <thead>
                <tr>
                    <th style="width: 40%;">태그</th>
                    <th style="width: 30%;">우선순위(sortOrder)</th>
                    <th style="width: 30%;">작업</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="pt : ${post.postTags}"
                    th:data-tag-id="${pt.tag.id}">
                    <td th:text="${pt.tag.name}"></td>
                    <td>
                        <input type="number"
                               class="form-control form-control-sm"
                               th:value="${pt.sortOrder != null ? pt.sortOrder : 0}">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                onClick="onTagOrderSubmit(this)">
                            변경
                        </button>
                    </td>
                    <td>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                onclick="onTagDelete(this)">
                            삭제
                        </button>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(post.postTags)}" class="text-muted">
                    <td colspan="3">현재 이 게시글에 연결된 태그가 없습니다.</td>
                </tr>
                </tbody>
            </table>

            <hr/>

            <!-- 태그 추가 영역 -->
            <div class="d-flex gap-2 align-items-center mb-2">
                <select class="form-select" id="newTagSelect">
                    <option value="">태그 선택</option>
                    <option th:each="tag : ${allTags}"
                            th:value="${tag.id}"
                            th:text="${tag.name}"></option>
                </select>
                <button type="button"
                        class="btn btn-outline-primary"
                        onclick="onTagAdd()">
                    태그 추가
                </button>
            </div>

            <small class="text-muted d-block mt-2">
                ※ 숫자가 작을수록 우선순위가 높습니다.
                입력 후 자동으로 1,2,3,… 로 재정렬됩니다.
            </small>

        </div>
    </div>

    <div th:replace="~{layout/footer :: footer}"></div>

    <!-- 태그 편집용 JS (기존 그대로) -->
    <script th:inline="javascript">
        const postId = [[${post.id}]];

        function toggleTagEditor() {
            const panel = document.getElementById('tagEditorPanel');
            if (!panel) return;
            const current = panel.style.display;
            panel.style.display = (!current || current === 'none') ? 'block' : 'none';
        }

        function renderTagTable(tags) {
            const tbody = document.querySelector('#tagEditTable tbody');
            tbody.innerHTML = '';

            if (!tags || tags.length === 0) {
                const tr = document.createElement('tr');
                tr.classList.add('text-muted');
                tr.innerHTML = '<td colspan="3">현재 이 게시글에 연결된 태그가 없습니다.</td>';
                tbody.appendChild(tr);
                return;
            }

            tags.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.tagId = item.tagId;
                tr.innerHTML = `
                    <td>${item.tagName}</td>
                    <td>
                        <input type="number"
                               class="form-control form-control-sm"
                               value="${item.sortOrder}">
                         <button type="button"
                                 class="btn btn-outline-secondary"
                                 onClick="onTagOrderSubmit(this)">
                            변경
                         </button>
                    </td>
                    <td>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                onclick="onTagDelete(this)">
                            삭제
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderTagBadges(tags) {
            const container = document.getElementById('tagDisplay');
            if (!container) return;

            container.innerHTML = '';

            if (!tags || tags.length === 0) {
                const span = document.createElement('span');
                span.classList.add('text-muted');
                span.textContent = '등록된 태그가 없습니다.';
                container.appendChild(span);
                return;
            }

            tags.forEach(item => {
                const a = document.createElement('a');
                a.classList.add('badge', 'text-bg-secondary', 'me-1', 'text-decoration-none');
                a.textContent = item.tagName;
                a.href = `/tag/posts?id=${item.tagId}`;
                container.appendChild(a);
            });
        }

        function onTagOrderSubmit(btnElem) {
            const tr = btnElem.closest('tr');
            const tagId = tr.dataset.tagId;
            const inputElem = tr.querySelector('input[type="number"]');
            const newOrder = inputElem.value || 0;

            const params = new URLSearchParams();
            params.append('postId', postId);
            params.append('tagId', tagId);
            params.append('sortOrder', newOrder);

            fetch('/post/tag/order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            })
                .then(res => {
                    if (!res.ok) throw new Error('서버 오류');
                    return res.json();
                })
                .then(tags => {
                    renderTagTable(tags);
                    renderTagBadges(tags);
                })
                .catch(err => {
                    console.error(err);
                    alert('우선순위 업데이트 중 오류가 발생했습니다.');
                });
        }

        function onTagDelete(btn) {
            const tr = btn.closest('tr');
            const tagId = tr.dataset.tagId;

            if (!confirm('이 태그를 삭제하시겠습니까?')) return;

            const params = new URLSearchParams();
            params.append('postId', postId);
            params.append('tagId', tagId);

            fetch('/post/tag/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            })
                .then(res => {
                    if (!res.ok) throw new Error('서버 오류');
                    return res.json();
                })
                .then(tags => {
                    renderTagTable(tags);
                    renderTagBadges(tags);
                })
                .catch(err => {
                    console.error(err);
                    alert('태그 삭제 중 오류가 발생했습니다.');
                });
        }

        function onTagAdd() {
            const select = document.getElementById('newTagSelect');
            const tagId = select.value;

            if (!tagId) {
                alert('추가할 태그를 선택해 주세요.');
                return;
            }

            const existingRows = document.querySelectorAll('#tagEditTable tbody tr[data-tag-id]');
            for (let i = 0; i < existingRows.length; i++) {
                if (existingRows[i].dataset.tagId === tagId) {
                    alert('이미 추가된 태그입니다.');
                    return;
                }
            }

            const params = new URLSearchParams();
            params.append('postId', postId);
            params.append('tagId', tagId);

            fetch('/post/tag/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            })
                .then(res => {
                    if (!res.ok) throw new Error('서버 오류');
                    return res.json();
                })
                .then(tags => {
                    renderTagTable(tags);
                    renderTagBadges(tags);
                    select.value = '';
                })
                .catch(err => {
                    console.error(err);
                    alert('태그 추가 중 오류가 발생했습니다.');
                });
        }
    </script>

</div>
</body>
</html>
