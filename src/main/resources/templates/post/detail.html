<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<th:block th:replace="~{layout/head :: head}"></th:block>
<style>
    .content-scroll-box {
        max-height: 480px;
        overflow-y: auto;
        overflow-x: hidden;
    }
    .content-scroll-box img {
        display: block;
        max-width: 100%;
        height: auto;
        margin: 1rem auto;
        width: 100%;
    }
    .content-scroll-box p {
        margin-bottom: 1rem;
        /*line-height: 1.7;*/
    }
    .content-scroll-box h4,
    .content-scroll-box h5,
    .content-scroll-box h6 {
        margin-top: 1.8rem;
        margin-bottom: 0.8rem;
    }

    .content-scroll-box ul {
        /*margin-left: 1.2rem;*/
        margin-bottom: 1.2rem;
    }

    .content-scroll-box figure > img {
        width: 33%;
    }
    /* ì„ íƒëœ ì–¸ì–´ ë²„íŠ¼: í° í…Œë‘ë¦¬ + ì‚´ì§ ê·¸ë¦¼ì */
    .lang-btn.is-selected {
        border: 1px solid #fff !important;
        box-shadow: 0 0 0 0.15rem rgba(255, 255, 255, 0.25);
    }

    /* Tag editor panel */
    .tag-panel {
        background: #fafafa;
    }

    .tag-item {
        background: #fff;
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 12px;
        padding: .6rem .75rem;
    }

    .tag-chip {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        padding: .25rem .55rem;
        border-radius: 999px;
        background: rgba(13,110,253,.08);
        color: #0d6efd;
        font-weight: 600;
        font-size: .85rem;
    }

    .tag-actions {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
    }

    .tag-order-input {
        width: 92px;
    }


</style>
<style>
    pre code {
        white-space: pre-wrap;
        word-break: break-word;
    }
</style>

<body>
<th:block th:replace="~{layout/header :: header}"></th:block>
<div class="container mt-5">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
        <h2 class="mb-0" th:text="${post.title}">ê²Œì‹œê¸€ ì œëª©</h2>

        <div class="d-flex flex-wrap align-items-center justify-content-md-end gap-2">

            <!-- ë²ˆì—­ ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="btn-group" role="group" aria-label="Translate">
                <a class="btn btn-sm lang-btn"
                   th:classappend="${langs.contains('kr')} ? ' btn-primary is-selected' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='kr')}">KR</a>

                <a class="btn btn-sm lang-btn"
                   th:classappend="${langs.contains('jp')} ? ' btn-primary is-selected' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='jp')}">JP</a>

                <a class="btn btn-sm lang-btn"
                   th:classappend="${langs.contains('cn')} ? ' btn-primary is-selected' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='cn')}">CN</a>

                <a class="btn btn-sm lang-btn"
                   th:classappend="${langs.contains('en')} ? ' btn-primary is-selected' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='en')}">EN</a>
            </div>

            <a class="btn btn-sm btn-outline-secondary" th:href="@{/post/update(id=${post.id})}">ìˆ˜ì •</a>
            <a class="btn btn-sm btn-outline-dark" th:href="@{/post/list}">ëª©ë¡</a>
        </div>
    </div>

    <!-- ë©”íƒ€ ì •ë³´ ì˜ì—­ -->
    <div class="mb-3 text-muted">
        <span th:text="'ì‘ì„±ì: ' + ${post.author}"></span>
<!--        <span class="ms-3"-->
<!--              th:text="'ì‘ì„±ì¼: ' + ${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span>-->
        <!-- âœ… ë°œí–‰ì¼ (releaseDate) í‘œì‹œ -->
        <span class="ms-3"
              th:if="${post.releaseDate != null}"
              th:text="'ë°œí–‰ì¼: ' + ${#temporals.format(post.releaseDate, 'yyyy-MM-dd')}"></span>
    </div>

    <!-- âœ… ì¸ë„¤ì¼ ì˜ì—­ -->
    <div class="mb-3"
         th:if="${post.thumbnail != null and !#strings.isEmpty(post.thumbnail)}">
        <strong>ì¸ë„¤ì¼</strong>
        <div class="mt-2">
            <img th:src="${post.thumbnail}"
                 alt="ì¸ë„¤ì¼"
                 class="img-thumbnail mb-1"
                 style="max-height: 200px;">
            <div class="small text-muted text-truncate"
                 th:text="${post.thumbnail}"></div>
        </div>
    </div>

    <div class="mb-3">
        <strong>ìš”ì•½</strong>
        <p class="form-control-plaintext border rounded p-3 content-scroll-box" th:text="${post.summary} ?: 'ìš”ì•½ ì—†ìŒ'"></p>
    </div>

    <!-- íƒœê·¸ ì„¹ì…˜ -->
    <div class="mb-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <strong>íƒœê·¸</strong>
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        onclick="toggleTagEditor()">
                    íƒœê·¸ ìˆ˜ì •
                </button>
            </div>
            <small class="text-muted">
                â€» ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŠµë‹ˆë‹¤. ì €ì¥ ì‹œ ìë™ ì¬ì •ë ¬ë©ë‹ˆë‹¤.
            </small>
        </div>

        <!-- í˜„ì¬ íƒœê·¸ ë±ƒì§€ í‘œì‹œ ì˜ì—­ -->
        <div class="mt-2" id="tagDisplay">
            <a th:each="pt : ${post.postTags}"
               th:href="@{/tag/posts(id=${pt.tag.id})}"
               class="badge text-bg-secondary me-1 text-decoration-none"
               th:text="${pt.tag.name}">
            </a>
            <span th:if="${#lists.isEmpty(post.postTags)}" class="text-muted">
            ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.
        </span>
        </div>

        <!-- ì¸ë¼ì¸ íƒœê·¸ í¸ì§‘ íŒ¨ë„ -->
        <div id="tagEditorPanel" class="mt-3 border rounded p-3 tag-panel" style="display:none;">

            <!-- âœ… í¸ì§‘ìš© ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ì˜ì—­ -->
            <div id="tagEditList" class="d-flex flex-column gap-2">
                <!-- JSë¡œ ë Œë”ë§ -->
            </div>

            <hr class="my-3"/>

            <!-- íƒœê·¸ ì¶”ê°€ ì˜ì—­ -->
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <select class="form-select form-select-sm" id="newTagSelect" style="min-width: 220px;">
                    <option value="">íƒœê·¸ ì„ íƒ</option>
                    <option th:each="tag : ${allTags}"
                            th:value="${tag.id}"
                            th:text="${tag.name}"></option>
                </select>
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        onclick="onTagAdd()">
                    ì¶”ê°€
                </button>
            </div>

        </div>
    </div>

    <div class="mb-4">
        <strong>ë‚´ìš©</strong>
        <!-- content ê°€ HTMLì´ë©´ th:utext, ìˆœìˆ˜ í…ìŠ¤íŠ¸ë©´ th:text -->
<!--        <div class="border rounded p-3 content-scroll-box" th:utext="${post.content}"></div>-->
        <!-- ğŸ”¹ íƒ­ ë²„íŠ¼ -->
        <ul class="nav nav-tabs" id="contentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active"
                        data-bs-toggle="tab"
                        data-bs-target="#render-pane"
                        type="button">
                    ë³´ê¸°
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link"
                        data-bs-toggle="tab"
                        data-bs-target="#html-pane"
                        type="button">
                    HTML
                </button>
            </li>
        </ul>

        <!-- ğŸ”¹ íƒ­ ë‚´ìš© -->
        <div class="tab-content border border-top-0 p-3">

            <!-- â‘  ì‹¤ì œ ë Œë”ë§ í™”ë©´ -->
            <div class="tab-pane fade show active" id="render-pane">
                <div class="border rounded p-3 content-scroll-box" th:utext="${post.content}"></div>
            </div>

            <!-- â‘¡ HTML ì›ë¬¸ ë³´ê¸° -->
            <div class="tab-pane fade" id="html-pane">
                <div class="border rounded p-3 content-scroll-box">
                    <pre class="mb-0"><code th:text="${post.content}"></code></pre>
                </div>
            </div>

        </div>
    </div>



    <div th:replace="~{layout/footer :: footer}"></div>

    <!-- íƒœê·¸ í¸ì§‘ìš© JS (ê¸°ì¡´ ê·¸ëŒ€ë¡œ) -->
    <script th:inline="javascript">
        const postId = [[${post.id}]];

        function toggleTagEditor() {
            const panel = document.getElementById('tagEditorPanel');
            if (!panel) return;

            const isOpening = (!panel.style.display || panel.style.display === 'none');
            panel.style.display = isOpening ? 'block' : 'none';

            if (isOpening) {
                // DOMì—ì„œ í˜„ì¬ íƒœê·¸ë¥¼ ì½ì–´ì„œ ì„ì‹œ ë Œë” (sortOrderëŠ” 0ìœ¼ë¡œ)
                const badges = document.querySelectorAll('#tagDisplay a.badge');
                const tags = [];
                badges.forEach(a => {
                    const href = a.getAttribute('href') || '';
                    const m = href.match(/id=(\d+)/);
                    const tagId = m ? Number(m[1]) : null;
                    if (tagId) tags.push({ tagId, tagName: a.textContent.trim(), sortOrder: 0 });
                });
                renderTagEditor(tags);
            }
        }


        function renderTagEditor(tags) {
            const list = document.getElementById('tagEditList');
            if (!list) return;

            list.innerHTML = '';

            if (!tags || tags.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'text-muted';
                empty.textContent = 'í˜„ì¬ ì´ ê²Œì‹œê¸€ì— ì—°ê²°ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                list.appendChild(empty);
                return;
            }

            tags.forEach(item => {
                const row = document.createElement('div');
                row.className = 'tag-item d-flex align-items-center justify-content-between flex-wrap gap-2';
                row.dataset.tagId = item.tagId;

                row.innerHTML = `
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="tag-chip">${item.tagName}</span>
                <a class="small text-muted text-decoration-none" href="/tag/posts?id=${item.tagId}">
                    íƒœê·¸ í˜ì´ì§€ â†’
                </a>
            </div>

            <div class="tag-actions">
                <input type="number"
                       class="form-control form-control-sm tag-order-input"
                       value="${item.sortOrder ?? 0}"
                       min="0" />
                <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        onclick="onTagOrderSubmit(this)">
                    ì €ì¥
                </button>
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        onclick="onTagDelete(this)">
                    ì‚­ì œ
                </button>
            </div>
        `;

                list.appendChild(row);
            });
        }


        function renderTagBadges(tags) {
            const container = document.getElementById('tagDisplay');
            if (!container) return;

            container.innerHTML = '';

            if (!tags || tags.length === 0) {
                const span = document.createElement('span');
                span.classList.add('text-muted');
                span.textContent = 'ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                container.appendChild(span);
                return;
            }

            tags.forEach(item => {
                const a = document.createElement('a');
                a.classList.add('badge', 'text-bg-secondary', 'me-1', 'text-decoration-none');
                a.textContent = item.tagName;
                a.href = `/tag/posts?id=${item.tagId}`;
                container.appendChild(a);
            });
        }

        function onTagOrderSubmit(btnElem) {
            const tr = btnElem.closest('tr');
            const tagId = tr.dataset.tagId;
            const inputElem = tr.querySelector('input[type="number"]');
            const newOrder = inputElem.value || 0;

            const params = new URLSearchParams();
            params.append('postId', postId);
            params.append('tagId', tagId);
            params.append('sortOrder', newOrder);

            fetch('/post/tag/order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            })
                .then(res => {
                    if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                    return res.json();
                })
                .then(tags => {
                    renderTagEditor(tags);
                    renderTagBadges(tags);
                })
                .catch(err => {
                    console.error(err);
                    alert('ìš°ì„ ìˆœìœ„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function onTagDelete(btn) {
            const tr = btn.closest('tr');
            const tagId = tr.dataset.tagId;

            if (!confirm('ì´ íƒœê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const params = new URLSearchParams();
            params.append('postId', postId);
            params.append('tagId', tagId);

            fetch('/post/tag/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            })
                .then(res => {
                    if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                    return res.json();
                })
                .then(tags => {
                    renderTagEditor(tags);
                    renderTagBadges(tags);
                })
                .catch(err => {
                    console.error(err);
                    alert('íƒœê·¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function onTagAdd() {
            const select = document.getElementById('newTagSelect');
            const tagId = select.value;

            if (!tagId) {
                alert('ì¶”ê°€í•  íƒœê·¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }

            const existingRows = document.querySelectorAll('#tagEditTable tbody tr[data-tag-id]');
            for (let i = 0; i < existingRows.length; i++) {
                if (existingRows[i].dataset.tagId === tagId) {
                    alert('ì´ë¯¸ ì¶”ê°€ëœ íƒœê·¸ì…ë‹ˆë‹¤.');
                    return;
                }
            }

            const params = new URLSearchParams();
            params.append('postId', postId);
            params.append('tagId', tagId);

            fetch('/post/tag/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            })
                .then(res => {
                    if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                    return res.json();
                })
                .then(tags => {
                    renderTagEditor(tags);
                    renderTagBadges(tags);
                    select.value = '';
                })
                .catch(err => {
                    console.error(err);
                    alert('íƒœê·¸ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
    </script>

</div>
</body>
</html>
