<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<th:block th:replace="~{layout/head :: head}"></th:block>
<style>
    .content-scroll-box {
        max-height: 480px;
        overflow-y: auto;
        overflow-x: hidden;
    }
    .content-scroll-box img {
        display: block;
        max-width: 100%;
        height: auto;
        margin: 1rem auto;
        width: 100%;
    }
    .content-scroll-box p {
        margin-bottom: 1rem;
        /*line-height: 1.7;*/
    }
    .content-scroll-box h4,
    .content-scroll-box h5,
    .content-scroll-box h6 {
        margin-top: 1.8rem;
        margin-bottom: 0.8rem;
    }

    .content-scroll-box ul {
        /*margin-left: 1.2rem;*/
        margin-bottom: 1.2rem;
    }

    .content-scroll-box figure > img {
        width: 33%;
    }
</style>
<style>
    pre code {
        white-space: pre-wrap;
        word-break: break-word;
    }
</style>

<body>
<th:block th:replace="~{layout/header :: header}"></th:block>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 th:text="${post.title}">ê²Œì‹œê¸€ ì œëª©</h2>
        <div>

            <!-- ë²ˆì—­ ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="btn-group me-2" role="group" aria-label="Translate">
                <a class="btn btn-sm btn-outline-primary"
                   th:classappend="${langs.contains('kr')}  ? ' btn-primary text-white' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='kr')}">
                    KR
                </a>
                <a class="btn btn-sm btn-outline-primary"
                   th:classappend="${langs.contains('jp')} ? ' btn-primary text-white' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='jp')}">
                    JP
                </a>
                <a class="btn btn-sm btn-outline-primary"
                   th:classappend="${langs.contains('cn')} ? ' btn-primary text-white' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='cn')}">
                    CN
                </a>
                <a class="btn btn-sm btn-outline-primary"
                   th:classappend="${langs.contains('en')} ? ' btn-primary text-white' : ' btn-outline-primary'"
                   th:href="@{/post/translate(id=${post.id}, languageCode='en')}">
                    EN
                </a>
            </div>

            <a class="btn btn-outline-secondary me-2"
               th:href="@{/post/update(id=${post.id})}">ìˆ˜ì •</a>
            <a class="btn btn-outline-dark"
               th:href="@{/post/list}">ëª©ë¡</a>
        </div>
    </div>

    <!-- ë©”íƒ€ ì •ë³´ ì˜ì—­ -->
    <div class="mb-3 text-muted">
        <span th:text="'ì‘ì„±ì: ' + ${post.author}"></span>
<!--        <span class="ms-3"-->
<!--              th:text="'ì‘ì„±ì¼: ' + ${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span>-->
        <!-- âœ… ë°œí–‰ì¼ (releaseDate) í‘œì‹œ -->
        <span class="ms-3"
              th:if="${post.releaseDate != null}"
              th:text="'ë°œí–‰ì¼: ' + ${#temporals.format(post.releaseDate, 'yyyy-MM-dd')}"></span>
    </div>

    <!-- âœ… ì¸ë„¤ì¼ ì˜ì—­ -->
    <div class="mb-3"
         th:if="${post.thumbnail != null and !#strings.isEmpty(post.thumbnail)}">
        <strong>ì¸ë„¤ì¼</strong>
        <div class="mt-2">
            <img th:src="${post.thumbnail}"
                 alt="ì¸ë„¤ì¼"
                 class="img-thumbnail mb-1"
                 style="max-height: 200px;">
            <div class="small text-muted text-truncate"
                 th:text="${post.thumbnail}"></div>
        </div>
    </div>

    <div class="mb-3">
        <strong>ìš”ì•½</strong>
        <p class="form-control-plaintext border rounded p-3 content-scroll-box" th:text="${post.summary} ?: 'ìš”ì•½ ì—†ìŒ'"></p>
    </div>

    <div class="mb-4">
        <strong>ë‚´ìš©</strong>
        <!-- content ê°€ HTMLì´ë©´ th:utext, ìˆœìˆ˜ í…ìŠ¤íŠ¸ë©´ th:text -->
<!--        <div class="border rounded p-3 content-scroll-box" th:utext="${post.content}"></div>-->
        <!-- ğŸ”¹ íƒ­ ë²„íŠ¼ -->
        <ul class="nav nav-tabs" id="contentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active"
                        data-bs-toggle="tab"
                        data-bs-target="#render-pane"
                        type="button">
                    ë³´ê¸°
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link"
                        data-bs-toggle="tab"
                        data-bs-target="#html-pane"
                        type="button">
                    HTML
                </button>
            </li>
        </ul>

        <!-- ğŸ”¹ íƒ­ ë‚´ìš© -->
        <div class="tab-content border border-top-0 p-3">

            <!-- â‘  ì‹¤ì œ ë Œë”ë§ í™”ë©´ -->
            <div class="tab-pane fade show active" id="render-pane">
                <div th:utext="${post.content}"></div>
            </div>

            <!-- â‘¡ HTML ì›ë¬¸ ë³´ê¸° -->
            <div class="tab-pane fade" id="html-pane">
                <pre class="mb-0"><code th:text="${post.content}"></code></pre>
            </div>

        </div>
    </div>

    <!-- íƒœê·¸ ì„¹ì…˜ -->
    <div class="mb-4">
        <div class="d-flex align-items-center">
            <strong>íƒœê·¸</strong>
            <button type="button"
                    class="btn btn-sm btn-outline-primary ms-2"
                    onclick="toggleTagEditor()">
                íƒœê·¸ ìˆ˜ì •
            </button>
        </div>

        <!-- í˜„ì¬ íƒœê·¸ ë±ƒì§€ í‘œì‹œ ì˜ì—­ -->
        <div class="mt-2" id="tagDisplay">
            <a th:each="pt : ${post.postTags}"
               th:href="@{/tag/posts(id=${pt.tag.id})}"
               class="badge text-bg-secondary me-1 text-decoration-none"
               th:text="${pt.tag.name}">
            </a>
            <span th:if="${#lists.isEmpty(post.postTags)}" class="text-muted">
                ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.
            </span>
        </div>

        <!-- ì¸ë¼ì¸ íƒœê·¸ í¸ì§‘ íŒ¨ë„ -->
        <div id="tagEditorPanel" class="mt-3 border rounded p-3" style="display: none;">

            <!-- íƒœê·¸ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
            <table class="table align-middle" id="tagEditTable">
                <thead>
                <tr>
                    <th style="width: 40%;">íƒœê·¸</th>
                    <th style="width: 30%;">ìš°ì„ ìˆœìœ„(sortOrder)</th>
                    <th style="width: 30%;">ì‘ì—…</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="pt : ${post.postTags}"
                    th:data-tag-id="${pt.tag.id}">
                    <td th:text="${pt.tag.name}"></td>
                    <td>
                        <input type="number"
                               class="form-control form-control-sm"
                               th:value="${pt.sortOrder != null ? pt.sortOrder : 0}">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                onClick="onTagOrderSubmit(this)">
                            ë³€ê²½
                        </button>
                    </td>
                    <td>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                onclick="onTagDelete(this)">
                            ì‚­ì œ
                        </button>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(post.postTags)}" class="text-muted">
                    <td colspan="3">í˜„ì¬ ì´ ê²Œì‹œê¸€ì— ì—°ê²°ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                </tbody>
            </table>

            <hr/>

            <!-- íƒœê·¸ ì¶”ê°€ ì˜ì—­ -->
            <div class="d-flex gap-2 align-items-center mb-2">
                <select class="form-select" id="newTagSelect">
                    <option value="">íƒœê·¸ ì„ íƒ</option>
                    <option th:each="tag : ${allTags}"
                            th:value="${tag.id}"
                            th:text="${tag.name}"></option>
                </select>
                <button type="button"
                        class="btn btn-outline-primary"
                        onclick="onTagAdd()">
                    íƒœê·¸ ì¶”ê°€
                </button>
            </div>

            <small class="text-muted d-block mt-2">
                â€» ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŠµë‹ˆë‹¤.
                ì…ë ¥ í›„ ìë™ìœ¼ë¡œ 1,2,3,â€¦ ë¡œ ì¬ì •ë ¬ë©ë‹ˆë‹¤.
            </small>

        </div>
    </div>

    <div th:replace="~{layout/footer :: footer}"></div>

    <!-- íƒœê·¸ í¸ì§‘ìš© JS (ê¸°ì¡´ ê·¸ëŒ€ë¡œ) -->
    <script th:inline="javascript">
        const postId = [[${post.id}]];

        function toggleTagEditor() {
            const panel = document.getElementById('tagEditorPanel');
            if (!panel) return;
            const current = panel.style.display;
            panel.style.display = (!current || current === 'none') ? 'block' : 'none';
        }

        function renderTagTable(tags) {
            const tbody = document.querySelector('#tagEditTable tbody');
            tbody.innerHTML = '';

            if (!tags || tags.length === 0) {
                const tr = document.createElement('tr');
                tr.classList.add('text-muted');
                tr.innerHTML = '<td colspan="3">í˜„ì¬ ì´ ê²Œì‹œê¸€ì— ì—°ê²°ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
                tbody.appendChild(tr);
                return;
            }

            tags.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.tagId = item.tagId;
                tr.innerHTML = `
                    <td>${item.tagName}</td>
                    <td>
                        <input type="number"
                               class="form-control form-control-sm"
                               value="${item.sortOrder}">
                         <button type="button"
                                 class="btn btn-outline-secondary"
                                 onClick="onTagOrderSubmit(this)">
                            ë³€ê²½
                         </button>
                    </td>
                    <td>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                onclick="onTagDelete(this)">
                            ì‚­ì œ
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderTagBadges(tags) {
            const container = document.getElementById('tagDisplay');
            if (!container) return;

            container.innerHTML = '';

            if (!tags || tags.length === 0) {
                const span = document.createElement('span');
                span.classList.add('text-muted');
                span.textContent = 'ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                container.appendChild(span);
                return;
            }

            tags.forEach(item => {
                const a = document.createElement('a');
                a.classList.add('badge', 'text-bg-secondary', 'me-1', 'text-decoration-none');
                a.textContent = item.tagName;
                a.href = `/tag/posts?id=${item.tagId}`;
                container.appendChild(a);
            });
        }

        function onTagOrderSubmit(btnElem) {
            const tr = btnElem.closest('tr');
            const tagId = tr.dataset.tagId;
            const inputElem = tr.querySelector('input[type="number"]');
            const newOrder = inputElem.value || 0;

            const params = new URLSearchParams();
            params.append('postId', postId);
            params.append('tagId', tagId);
            params.append('sortOrder', newOrder);

            fetch('/post/tag/order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            })
                .then(res => {
                    if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                    return res.json();
                })
                .then(tags => {
                    renderTagTable(tags);
                    renderTagBadges(tags);
                })
                .catch(err => {
                    console.error(err);
                    alert('ìš°ì„ ìˆœìœ„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function onTagDelete(btn) {
            const tr = btn.closest('tr');
            const tagId = tr.dataset.tagId;

            if (!confirm('ì´ íƒœê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const params = new URLSearchParams();
            params.append('postId', postId);
            params.append('tagId', tagId);

            fetch('/post/tag/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            })
                .then(res => {
                    if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                    return res.json();
                })
                .then(tags => {
                    renderTagTable(tags);
                    renderTagBadges(tags);
                })
                .catch(err => {
                    console.error(err);
                    alert('íƒœê·¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function onTagAdd() {
            const select = document.getElementById('newTagSelect');
            const tagId = select.value;

            if (!tagId) {
                alert('ì¶”ê°€í•  íƒœê·¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }

            const existingRows = document.querySelectorAll('#tagEditTable tbody tr[data-tag-id]');
            for (let i = 0; i < existingRows.length; i++) {
                if (existingRows[i].dataset.tagId === tagId) {
                    alert('ì´ë¯¸ ì¶”ê°€ëœ íƒœê·¸ì…ë‹ˆë‹¤.');
                    return;
                }
            }

            const params = new URLSearchParams();
            params.append('postId', postId);
            params.append('tagId', tagId);

            fetch('/post/tag/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params.toString()
            })
                .then(res => {
                    if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                    return res.json();
                })
                .then(tags => {
                    renderTagTable(tags);
                    renderTagBadges(tags);
                    select.value = '';
                })
                .catch(err => {
                    console.error(err);
                    alert('íƒœê·¸ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
    </script>

</div>
</body>
</html>
