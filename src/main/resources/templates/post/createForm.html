<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<th:block th:replace="~{layout/head :: head}"></th:block>

<style>
    #content figure > img { width: 33%; }

    .tag-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .tag-name { display:flex; align-items:center; gap:10px; }
    .tag-primary { white-space:nowrap; }
    .tag-primary label { margin-left: 6px; }
</style>

<body>
<th:block th:replace="~{layout/header :: header}"></th:block>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>새 게시글 작성</h2>
        <a class="btn btn-outline-dark" th:href="@{/post/list}">목록</a>
    </div>

    <form id="postForm" method="post" enctype="multipart/form-data">
        <!-- ✅ create 전용이라 id hidden 제거 -->

        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input type="text"
                   id="title"
                   name="title"
                   class="form-control"
                   th:value="${post.title}"
                   required>
        </div>

        <div class="mb-3">
            <label for="summary" class="form-label">요약</label>
            <input type="text"
                   id="summary"
                   name="summary"
                   class="form-control"
                   th:value="${post.summary}">
        </div>

        <div class="mb-3">
            <label for="author" class="form-label">작성자</label>
            <input type="text"
                   id="author"
                   name="author"
                   class="form-control"
                   th:value="${post.author}">
        </div>

        <div class="mb-3">
            <label for="releaseDate" class="form-label">발행일</label>
            <input type="date"
                   id="releaseDate"
                   name="releaseDate"
                   class="form-control"
                   th:value="${post.releaseDate}">
        </div>

        <!-- ✅ 썸네일 URL + 업로드 + 미리보기 -->
        <div class="mb-3">
            <label for="thumbnail" class="form-label">썸네일</label>

            <div class="input-group">
                <input type="text"
                       id="thumbnail"
                       name="thumbnail"
                       class="form-control"
                       placeholder="https://example.com/image.jpg"
                       th:value="${post.thumbnail}">
                <button type="button"
                        class="btn btn-outline-secondary"
                        id="btnUploadThumbnail">
                    이미지 업로드
                </button>
            </div>

            <small class="text-muted d-block mt-1">
                직접 URL을 붙여넣거나, 이미지 업로드 버튼으로 파일을 올릴 수 있습니다.
            </small>

            <input type="file" id="thumbnailFile" accept="image/*" style="display:none;">

            <div class="mt-2">
                <img id="thumbnailPreview"
                     alt="썸네일 미리보기"
                     class="img-thumbnail"
                     style="max-height:150px; display:none;">
            </div>
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea id="content"
                      name="content"
                      rows="12"
                      class="form-control"
                      data-summernote
                      th:text="${post.content}"></textarea>
        </div>

        <!-- ✅ 태그 선택 + 대표 지정(create) -->
        <div class="mb-4">
            <label class="form-label">태그</label>

            <div class="border rounded p-2" style="max-height: 260px; overflow-y: auto;">
                <div class="form-check py-1" th:each="tag : ${allTags}">
                    <div class="tag-row">
                        <div class="tag-name">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="tagIds"
                                   th:id="${'tag-' + tag.id}"
                                   th:value="${tag.id}">
                            <label class="form-check-label"
                                   th:for="${'tag-' + tag.id}"
                                   th:text="${tag.name}"></label>
                        </div>

                        <!-- ✅ 대표 태그: 라디오 1개만 -->
                        <div class="tag-primary">
                            <input class="form-check-input primary-radio"
                                   type="radio"
                                   name="primaryTagId"
                                   th:id="${'primary-' + tag.id}"
                                   th:value="${tag.id}"
                                   disabled>
                            <label class="form-check-label" th:for="${'primary-' + tag.id}">
                                대표
                            </label>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(allTags)}" class="text-muted">
                    등록된 태그가 없습니다. 먼저 태그를 생성해 주세요.
                </div>
            </div>

            <small class="text-muted d-block mt-1">
                ※ “대표”는 한 개만 선택할 수 있으며, 체크된 태그만 대표로 지정 가능합니다.
            </small>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <a class="btn btn-outline-secondary" th:href="@{/post/list}">취소</a>
            <button type="button" class="btn btn-primary" id="btnSave">작성하기</button>
        </div>
    </form>
</div>

<div th:replace="~{layout/footer :: footer}"></div>

<!-- ✅ 썸네일 업로드 JS -->
<script th:inline="javascript">
    const uploadBtn = document.getElementById('btnUploadThumbnail');
    const fileInput = document.getElementById('thumbnailFile');
    const thumbnailInput = document.getElementById('thumbnail');
    const previewImg = document.getElementById('thumbnailPreview');

    if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            uploadBtn.disabled = true;
            const originalText = uploadBtn.textContent;
            uploadBtn.textContent = '업로드 중...';

            try {
                const response = await fetch('/api/upload/thumbnail', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('업로드 실패');

                const data = await response.json();
                const url = data.url;

                thumbnailInput.value = url;

                previewImg.src = url;
                previewImg.style.display = 'block';
            } catch (e) {
                console.error(e);
                alert('이미지 업로드 중 오류가 발생했습니다.');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
                fileInput.value = '';
            }
        });
    }

    // URL 직접 입력했을 때도 미리보기 반영(blur/change)
    function syncPreviewFromUrl() {
        const v = (thumbnailInput.value || '').trim();
        if (!v) {
            previewImg.style.display = 'none';
            previewImg.removeAttribute('src');
            return;
        }
        previewImg.src = v;
        previewImg.style.display = 'block';
    }
    thumbnailInput?.addEventListener('change', syncPreviewFromUrl);
    thumbnailInput?.addEventListener('blur', syncPreviewFromUrl);

    const initial = thumbnailInput?.value?.trim();
    if (initial) {
        previewImg.src = initial;
        previewImg.style.display = 'block';
    }
</script>

<!-- ✅ 대표 라디오: 체크된 태그만 활성화 -->
<script>
    function syncPrimaryEnablement() {
        document.querySelectorAll('input[name="tagIds"]').forEach(cb => {
            const tagId = cb.value;
            const radio = document.getElementById(`primary-${tagId}`);
            if (!radio) return;

            radio.disabled = !cb.checked;
            if (!cb.checked && radio.checked) radio.checked = false;
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        syncPrimaryEnablement();
        document.querySelectorAll('input[name="tagIds"]').forEach(cb => {
            cb.addEventListener('change', syncPrimaryEnablement);
        });
    });
</script>

<!-- ✅ 저장 JS: JSON(Map) 응답 받고 redirectUrl로 이동 -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        const formEl = document.getElementById('postForm');
        const btnSave = document.getElementById('btnSave');

        btnSave?.addEventListener('click', async () => {
            const formData = new FormData(formEl);

            const payload = window.getSummernotePayload({ editorSelector: '#content' });
            formData.set('content', payload.content);

            for (const f of payload.files) formData.append('files', f);

            fillPostTagsToFormData(formData);

            btnSave.disabled = true;
            const originalText = btnSave.textContent;
            btnSave.textContent = '저장 중...';

            try {
                const res = await fetch('/post/new', { method: 'POST', body: formData });
                if (!res.ok) throw new Error(await res.text());

                const data = await res.json(); // { id, redirectUrl }
                window.location.href = data.redirectUrl || (`/post/${data.id}`);
            } catch (e) {
                console.error(e);
                alert('저장 중 오류가 발생했습니다.\n' + (e.message ?? e));
            } finally {
                btnSave.disabled = false;
                btnSave.textContent = originalText;
            }
        });
    });

    function fillPostTagsToFormData(formData) {
        // 체크박스 기본 전송값 제거하고 postTags로만 보냄
        formData.delete('tagIds');

        const checked = Array.from(document.querySelectorAll('input[name="tagIds"]:checked'));

        // 대표 선택(tagId)
        const primaryRadio = document.querySelector('input[name="primaryTagId"]:checked');
        const primaryTagId = primaryRadio ? (primaryRadio.value || '').trim() : null;

        checked.forEach((cb, idx) => {
            const tagId = (cb.value || '').trim();
            const base = `postTags[${idx}]`;

            const isPrimary = (primaryTagId && primaryTagId === tagId) ? 'true' : 'false';

            formData.append(`${base}.tagId`, tagId);
            formData.append(`${base}.sortOrder`, String(idx + 1));
            formData.append(`${base}.primaryTag`, isPrimary);
        });
    }
</script>

</body>
</html>
