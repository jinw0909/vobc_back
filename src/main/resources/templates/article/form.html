<!--<!doctype html>-->
<!--<html lang="ko" xmlns:th="http://www.thymeleaf.org">-->
<!--<head th:replace="~{layout/head :: head}"></head>-->
<!--<style>-->
<!--  .note-editor .note-editable {-->
<!--    font-size: 16px;-->
<!--    line-height: 1.7; /* ê¸°ë³¸ê°’ */-->
<!--    word-break: break-word;-->
<!--  }-->
<!--  .note-editor .note-editable img {-->
<!--    max-width: 100% !important;-->
<!--    height: auto !important;-->
<!--  }-->
<!--  .note-editor .note-editable img[width] { width: auto !important; }-->
<!--  .note-editor .note-editable img[height] { height: auto !important; }-->
<!--</style>-->

<!--<body class="bg-light">-->
<!--<th:block th:replace="~{layout/header :: header}"></th:block>-->
<!--<div class="container py-4">-->
<!--  <h2 class="mb-3" th:text="${mode == 'edit' ? 'ê¸°ì‚¬ ìˆ˜ì •' : 'ê¸°ì‚¬ ì‘ì„±'}">ê¸°ì‚¬ ì‘ì„±</h2>-->

<!--  <form id="articleForm" class="card p-3" enctype="multipart/form-data">-->

<!--    <input type="hidden" id="mode" th:value="${mode}">-->
<!--    <input type="hidden" id="articleId" th:value="${articleId}">-->

<!--    <div class="mb-3">-->
<!--      <label class="form-label">ì œëª©</label>-->
<!--      <input class="form-control" name="title" id="title" required-->
<!--             th:value="${form.title}">-->
<!--    </div>-->

<!--    <div class="mb-3">-->
<!--      <label class="form-label">ìš”ì•½</label>-->
<!--      <textarea class="form-control" name="summary" id="summary" rows="2"-->
<!--                th:text="${form.summary}"></textarea>-->
<!--    </div>-->

<!--    <div class="mb-3">-->
<!--      <label class="form-label">ìƒì„¸</label>-->
<!--      <textarea class="form-control" name="description" id="description" rows="2"-->
<!--                th:text="${form.description}"></textarea>-->
<!--    </div>-->

<!--    <div class="mb-3">-->
<!--      <label class="form-label">ì‘ì„±ì</label>-->
<!--      <input class="form-control" name="author" id="author"-->
<!--             th:value="${form.author}">-->
<!--    </div>-->

<!--    <div class="mb-3">-->
<!--      <label class="form-label">ì¶œì‹œì¼</label>-->
<!--      <input type="date" class="form-control" name="releaseDate" id="releaseDate"-->
<!--             th:value="${form.releaseDate}">-->
<!--    </div>-->

<!--    &lt;!&ndash; âœ… ì¸ë„¤ì¼: URL ì§ì ‘ ì…ë ¥ + íŒŒì¼ ì—…ë¡œë“œ &ndash;&gt;-->
<!--    <div class="mb-3">-->
<!--      <label class="form-label">ì¸ë„¤ì¼</label>-->

<!--      <div class="input-group mb-2">-->
<!--        <input class="form-control" name="thumbnail" id="thumbnail" placeholder="https://... ë˜ëŠ” ì—…ë¡œë“œ"-->
<!--               th:value="${form.thumbnail}">-->
<!--        <button type="button" class="btn btn-outline-secondary" id="btnThumbPreview">ë¯¸ë¦¬ë³´ê¸°</button>-->
<!--        <button type="button" class="btn btn-outline-danger" id="btnThumbClear">ì§€ìš°ê¸°</button>-->
<!--      </div>-->

<!--      <div class="d-flex gap-2 align-items-center">-->
<!--        <input type="file" class="form-control" id="thumbnailFile" accept="image/*">-->
<!--        <button type="button" class="btn btn-primary" id="btnUploadThumb">ì—…ë¡œë“œ</button>-->
<!--      </div>-->

<!--      <div class="form-text">-->
<!--        URLì„ ì§ì ‘ ì…ë ¥í•´ë„ ë˜ê³ , íŒŒì¼ ì—…ë¡œë“œí•˜ë©´ URLì´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.-->
<!--      </div>-->

<!--      <div class="mt-2" style="max-width: 420px;">-->
<!--        <img id="thumbPreview" src="" alt="thumbnail preview"-->
<!--             style="display:none; width:100%; border-radius:8px; border:1px solid #e5e7eb;">-->
<!--      </div>-->
<!--    </div>-->

<!--    <div class="mb-3">-->
<!--      <label class="form-label">ë§í¬</label>-->
<!--      <input class="form-control" name="link" id="link" placeholder="https://..."-->
<!--             th:value="${form.link}">-->
<!--    </div>-->
<!--    <div class="mb-3">-->
<!--      <label class="form-label">Publisher</label>-->

<!--      &lt;!&ndash; nameì€ publisherIdë¡œ ë³´ë‚´ëŠ” ê±¸ ì¶”ì²œ &ndash;&gt;-->
<!--      <select class="form-select" name="publisherId" id="publisherId" required>-->
<!--        <option value="" th:selected="${form.publisher == null}">ì„ íƒ</option>-->

<!--        <option th:each="e : ${publishers.entrySet()}"-->
<!--                th:value="${e.key}"-->
<!--                th:text="${e.value}"-->
<!--                th:selected="${form.publisher != null and form.publisher.id == e.key}">-->
<!--        </option>-->
<!--      </select>-->

<!--      <div class="form-text">ì €ì¥ê°’ì€ Publisher ID ì…ë‹ˆë‹¤.</div>-->
<!--    </div>-->


<!--    <div class="mb-3">-->
<!--      <label class="form-label">ì¹´í…Œê³ ë¦¬</label>-->
<!--      <select class="form-select" name="category" id="category">-->
<!--        <option value="" th:selected="${form.category == null}">ì„ íƒ</option>-->
<!--        <option value="news" th:selected="${form.category != null and form.category.type == 'news'}">news</option>-->
<!--        <option value="event" th:selected="${form.category != null and form.category.type == 'event'}">event</option>-->
<!--        <option value="interview" th:selected="${form.category != null and form.category.type == 'interview'}">interview</option>-->
<!--        <option value="publicity" th:selected="${form.category != null and form.category.type == 'publicity'}">publicity</option>-->
<!--        <option value="editorial" th:selected="${form.category != null and form.category.type == 'editorial'}">editorial</option>-->
<!--      </select>-->
<!--    </div>-->

<!--    <div class="mb-2">-->
<!--      <label class="form-label">ë‚´ìš©</label>-->
<!--      <textarea id="content"-->
<!--                name="content"-->
<!--                rows="12"-->
<!--                class="form-control"-->
<!--                data-summernote-->
<!--                th:text="${article.content}"></textarea>-->
<!--      <div class="form-text">-->
<!--        ì´ë¯¸ì§€ ì‚½ì…ì€ ì €ì¥ ì‹œì ì— ì—…ë¡œë“œë©ë‹ˆë‹¤. (ì—ë””í„° ë‚´ë¶€ ë¯¸ë¦¬ë³´ê¸°ëŠ” blob)-->
<!--      </div>-->
<!--    </div>-->

<!--    <div class="d-flex gap-2 mt-3">-->
<!--      <button type="button" class="btn btn-primary" id="btnSave"-->
<!--              th:text="${mode == 'edit' ? 'ìˆ˜ì •' : 'ì €ì¥'}">ì €ì¥</button>-->
<!--      <a class="btn btn-outline-secondary" th:href="@{/article/list}">ì·¨ì†Œ</a>-->
<!--    </div>-->

<!--    <div class="mt-3 text-danger" id="errorBox" style="display:none;"></div>-->
<!--  </form>-->
<!--</div>-->

<!--<th:block th:replace="~{layout/footer :: footer}"></th:block>-->

<!--<script>-->
<!--  // ===== ì¸ë„¤ì¼: URL ì…ë ¥/ì—…ë¡œë“œ ê³µí†µ =====-->
<!--  function setThumbPreview(url) {-->
<!--    const img = document.getElementById('thumbPreview');-->
<!--    if (!url) {-->
<!--      img.style.display = 'none';-->
<!--      img.src = '';-->
<!--      return;-->
<!--    }-->
<!--    img.src = url;-->
<!--    img.style.display = 'block';-->
<!--  }-->

<!--  async function uploadThumbnail() {-->
<!--    const fileInput = document.getElementById('thumbnailFile');-->
<!--    const file = fileInput.files?.[0];-->
<!--    if (!file) throw new Error('ì¸ë„¤ì¼ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');-->

<!--    const fd = new FormData();-->
<!--    fd.append('file', file);-->

<!--    const res = await fetch('/api/upload/thumbnail', {-->
<!--      method: 'POST',-->
<!--      body: fd-->
<!--    });-->

<!--    if (!res.ok) throw new Error(await res.text());-->
<!--    const data = await res.json();-->

<!--    const url = data.url;-->
<!--    document.getElementById('thumbnail').value = url;-->
<!--    setThumbPreview(url);-->

<!--    // ì—…ë¡œë“œ ì„±ê³µ í›„ íŒŒì¼ ì„ íƒê°’ ì´ˆê¸°í™”(ì„ íƒ)-->
<!--    fileInput.value = '';-->
<!--  }-->
<!--</script>-->

<!--<script>-->
<!--  // ===== ë³¸ë¬¸ ì´ë¯¸ì§€ pendingFiles ë¡œì§(ê¸°ì¡´ ê·¸ëŒ€ë¡œ) =====-->
<!--  const pendingFiles = new Map();-->

<!--  function uuidv4() {-->
<!--    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();-->
<!--    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {-->
<!--      const r = Math.random() * 16 | 0;-->
<!--      const v = c === 'x' ? r : (r & 0x3 | 0x8);-->
<!--      return v.toString(16);-->
<!--    });-->
<!--  }-->

<!--  function getExtFromFile(file) {-->
<!--    const name = file.name || '';-->
<!--    const idx = name.lastIndexOf('.');-->
<!--    if (idx > -1) return name.substring(idx);-->
<!--    if (file.type === 'image/png') return '.png';-->
<!--    if (file.type === 'image/jpeg') return '.jpg';-->
<!--    if (file.type === 'image/webp') return '.webp';-->
<!--    return '';-->
<!--  }-->

<!--  function insertImageToEditor(file) {-->
<!--    const assetId = uuidv4();-->
<!--    const ext = getExtFromFile(file);-->
<!--    const renamed = new File([file], `${assetId}${ext}`, { type: file.type });-->

<!--    pendingFiles.set(assetId, renamed);-->

<!--    const blobUrl = URL.createObjectURL(renamed);-->
<!--    const imgHtml = `<img src="${blobUrl}" data-asset-id="${assetId}" alt="" />`;-->
<!--    $('#content').summernote('pasteHTML', imgHtml);-->
<!--  }-->

<!--  function syncPendingFilesWithEditor() {-->
<!--    const html = $('#content').summernote('code');-->
<!--    const temp = document.createElement('div');-->
<!--    temp.innerHTML = html;-->

<!--    const assetIdsInEditor = new Set(-->
<!--            Array.from(temp.querySelectorAll('img[data-asset-id]'))-->
<!--                    .map(img => img.getAttribute('data-asset-id'))-->
<!--                    .filter(Boolean)-->
<!--    );-->

<!--    for (const assetId of pendingFiles.keys()) {-->
<!--      if (!assetIdsInEditor.has(assetId)) pendingFiles.delete(assetId);-->
<!--    }-->
<!--  }-->

<!--  function getSaveUrl() {-->
<!--    const mode = document.getElementById('mode')?.value || 'create';-->
<!--    const articleId = document.getElementById('articleId')?.value;-->

<!--    if (mode === 'edit' && articleId && articleId !== 'null' && articleId !== 'undefined' && articleId !== '') {-->
<!--      return `/article/save?id=${encodeURIComponent(articleId)}`;-->
<!--    }-->
<!--    return '/article/save';-->
<!--  }-->

<!--  // ===== LH(í–‰ê°„) ë“œë¡­ë‹¤ìš´ + ì ìš© =====-->
<!--  function applyLineHeightToEditor(context, value) {-->
<!--    const range = context.invoke('editor.createRange');-->
<!--    if (!range) return;-->

<!--    const selector = 'p, li, div, h1, h2, h3, h4, h5, h6, blockquote';-->

<!--    // selectionì´ ì—†ìœ¼ë©´ ì»¤ì„œ ë¬¸ë‹¨ì—ë§Œ-->
<!--    if (range.isCollapsed()) {-->
<!--      const $block = $(range.sc).closest(selector);-->
<!--      if ($block.length) $block.css('line-height', value);-->
<!--      return;-->
<!--    }-->

<!--    // selectionì´ ìˆìœ¼ë©´ start~end ë¸”ë¡ì— ì ìš©-->
<!--    const nativeRange = range.nativeRange ? range.nativeRange() : range;-->
<!--    const startNode = nativeRange.startContainer;-->
<!--    const endNode = nativeRange.endContainer;-->

<!--    const $startBlock = $(startNode).closest(selector);-->
<!--    const $endBlock   = $(endNode).closest(selector);-->

<!--    const editable = $(range.sc).closest('.note-editable').get(0);-->
<!--    if (!editable) return;-->

<!--    if ($startBlock.length) $startBlock.css('line-height', value);-->

<!--    if ($startBlock.length && $endBlock.length && !$startBlock.is($endBlock)) {-->
<!--      const blocks = $(editable).find(selector);-->
<!--      let started = false;-->
<!--      blocks.each(function () {-->
<!--        const $b = $(this);-->
<!--        if ($b.is($startBlock)) started = true;-->
<!--        if (started) $b.css('line-height', value);-->
<!--        if ($b.is($endBlock)) return false;-->
<!--      });-->
<!--    }-->
<!--  }-->

<!--  function lineHeightButtonForContent(context) {-->
<!--    const ui = $.summernote.ui;-->

<!--    const saveRange = () => context.invoke('editor.saveRange');-->
<!--    const restoreRange = () => context.invoke('editor.restoreRange');-->

<!--    const values = ['1.0', '1.2', '1.4', '1.6', '1.8', '2.0'];-->

<!--    const dropdown = ui.dropdown({-->
<!--      items: values,-->
<!--      callback: function($dropdownNode) {-->
<!--        // Summernoteê°€ ë§Œë“  a íƒœê·¸ì— 1íšŒë§Œ ë°”ì¸ë”©(ì¤‘ë³µ ë°©ì§€)-->
<!--        $dropdownNode.find('a').off('click.lineheight').on('click.lineheight', function(e) {-->
<!--          e.preventDefault();-->
<!--          e.stopPropagation();-->

<!--          const value = $(this).text().trim();-->

<!--          restoreRange();-->
<!--          context.invoke('editor.focus');-->
<!--          applyLineHeightToEditor(context, value);-->
<!--        });-->
<!--      }-->
<!--    });-->

<!--    const button = ui.button({-->
<!--      className: 'dropdown-toggle',-->
<!--      contents: 'LH',-->
<!--      tooltip: 'Line height',-->
<!--      data: { toggle: 'dropdown', 'bs-toggle': 'dropdown' },-->
<!--      click: function() {-->
<!--        saveRange(); // ë“œë¡­ë‹¤ìš´ ì—´ê¸° ì „ì— selection ë³´ì¡´-->
<!--      }-->
<!--    });-->

<!--    return ui.buttonGroup([button, dropdown]).render();-->
<!--  }-->

<!--  // ===== ë¶™ì—¬ë„£ê¸°: ìŠ¤íƒ€ì¼ ì œê±°(plain textë§Œ) =====-->
<!--  function pastePlainText(e) {-->
<!--    e.preventDefault();-->
<!--    const text = (e.originalEvent || e).clipboardData.getData('text/plain');-->
<!--    document.execCommand('insertText', false, text);-->
<!--  }-->


<!--  $(function () {-->
<!--    // âœ… ì¸ë„¤ì¼ ì´ˆê¸° í”„ë¦¬ë·°-->
<!--    const initialThumb = document.getElementById('thumbnail')?.value?.trim();-->
<!--    if (initialThumb) setThumbPreview(initialThumb);-->

<!--    // ì¸ë„¤ì¼ ë²„íŠ¼ë“¤-->
<!--    $('#btnThumbPreview').on('click', function () {-->
<!--      const url = ($('#thumbnail').val() ?? '').toString().trim();-->
<!--      setThumbPreview(url);-->
<!--    });-->

<!--    $('#btnThumbClear').on('click', function () {-->
<!--      $('#thumbnail').val('');-->
<!--      setThumbPreview('');-->
<!--    });-->

<!--    // ì—…ë¡œë“œ ë²„íŠ¼-->
<!--    $('#btnUploadThumb').on('click', async function () {-->
<!--      $('#errorBox').hide().text('');-->
<!--      try {-->
<!--        await uploadThumbnail();-->
<!--      } catch (e) {-->
<!--        console.error(e);-->
<!--        $('#errorBox').show().text('ì¸ë„¤ì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (e.message ?? e));-->
<!--      }-->
<!--    });-->

<!--    // (ì„ íƒ) íŒŒì¼ ì„ íƒí•˜ë©´ ìë™ ì—…ë¡œë“œ-->
<!--    // $('#thumbnailFile').on('change', async function () { ... });-->

<!--    // âœ… summernote ì´ˆê¸°í™”-->
<!--    // âœ… summernote ì´ˆê¸°í™” (post translateì—ì„œ ì“°ë˜ íŒ¨í„´ ì ìš©)-->
<!--    $('#content').summernote({-->
<!--      height: 420,-->
<!--      placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”',-->

<!--      fontSizes: ['12', '14', '16', '18', '20', '24', '28', '32'],-->

<!--      toolbar: [-->
<!--        ['style', ['style']],-->
<!--        ['font', ['bold', 'italic', 'underline', 'clear']],-->
<!--        ['fontsize', ['fontsize']],-->
<!--        ['para', ['ul', 'ol', 'paragraph']],-->
<!--        ['insert', ['picture', 'link', 'table']],-->
<!--        ['custom', ['lineHeight']], // âœ… í–‰ê°„-->
<!--        ['view', ['codeview']]-->
<!--      ],-->

<!--      // âœ… ì»¤ìŠ¤í…€ ë²„íŠ¼ ë“±ë¡-->
<!--      buttons: {-->
<!--        lineHeight: lineHeightButtonForContent-->
<!--      },-->

<!--      callbacks: {-->
<!--        onImageUpload: function (files) {-->
<!--          if (!files || files.length === 0) return;-->
<!--          for (const f of files) insertImageToEditor(f);-->
<!--        },-->
<!--        onChange: function () {-->
<!--          syncPendingFilesWithEditor();-->
<!--        },-->
<!--        onPaste: pastePlainText,-->

<!--        // âœ… ë“œë¡­ë‹¤ìš´ í´ë¦­ ì‹œ selection ë‚ ì•„ê°€ëŠ” ë¬¸ì œ ë°©ì§€-->
<!--        onKeyup: function () { $('#content').summernote('saveRange'); },-->
<!--        onMouseup: function () { $('#content').summernote('saveRange'); },-->
<!--      }-->
<!--    });-->

<!--    $('#btnSave').on('click', async function () {-->
<!--      $('#errorBox').hide().text('');-->
<!--      syncPendingFilesWithEditor();-->

<!--      const formData = new FormData();-->
<!--      formData.append('title', $('#title').val() ?? '');-->
<!--      formData.append('summary', $('#summary').val() ?? '');-->
<!--      formData.append('description', $('#description').val() ?? '');-->
<!--      formData.append('author', $('#author').val() ?? '');-->
<!--      formData.append('releaseDate', $('#releaseDate').val() ?? '');-->
<!--      formData.append('thumbnail', $('#thumbnail').val() ?? ''); // âœ… URL ì§ì ‘ì…ë ¥/ì—…ë¡œë“œ ëª¨ë‘ ì—¬ê¸°ë¡œ ê°-->
<!--      formData.append('link', $('#link').val() ?? '');-->
<!--      formData.append('publisherId', $('#publisherId').val() ?? '');-->
<!--      formData.append('category', $('#category').val() ?? '');-->

<!--      formData.append('content', $('#content').summernote('code'));-->

<!--      for (const file of pendingFiles.values()) {-->
<!--        formData.append('files', file);-->
<!--      }-->

<!--      const saveUrl = getSaveUrl();-->
<!--      console.log('[save]', { saveUrl, mode: $('#mode').val(), articleId: $('#articleId').val(), files: pendingFiles.size });-->

<!--      try {-->
<!--        const res = await fetch(saveUrl, { method: 'POST', body: formData });-->
<!--        if (!res.ok) throw new Error(await res.text());-->

<!--        const data = await res.json();-->
<!--        window.location.href = `/article/detail?id=${data.id}`;-->
<!--      } catch (e) {-->
<!--        console.error(e);-->
<!--        $('#errorBox').show().text('ì €ì¥ ì‹¤íŒ¨: ' + (e.message ?? e));-->
<!--      }-->
<!--    });-->
<!--  });-->
<!--</script>-->
<!--</body>-->
<!--</html>-->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/head :: head}"></head>

<style>
  /* ì—ë””í„° ë³¸ë¬¸ íƒ€ì´í¬ */
  .note-editor .note-editable {
    font-size: 16px;
    line-height: 1.7;
    word-break: break-word;
  }
  .note-editor .note-editable img {
    max-width: 100% !important;
    height: auto !important;
  }
  .note-editor .note-editable img[width]  { width: auto !important; }
  .note-editor .note-editable img[height] { height: auto !important; }
</style>

<body class="bg-light">
<th:block th:replace="~{layout/header :: header}"></th:block>

<div class="container py-4">
  <h2 class="mb-3" th:text="${mode == 'edit' ? 'ê¸°ì‚¬ ìˆ˜ì •' : 'ê¸°ì‚¬ ì‘ì„±'}">ê¸°ì‚¬ ì‘ì„±</h2>

  <!-- âœ… fetchë¡œ ì €ì¥í•˜ë¯€ë¡œ action/method í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ, enctypeì€ ìœ ì§€ -->
  <form id="articleForm" class="card p-3" enctype="multipart/form-data">
    <input type="hidden" id="mode" th:value="${mode}">
    <input type="hidden" id="articleId" th:value="${articleId}">

    <div class="mb-3">
      <label class="form-label">ì œëª©</label>
      <input class="form-control" name="title" id="title" required th:value="${form.title}">
    </div>

    <div class="mb-3">
      <label class="form-label">ìš”ì•½</label>
      <textarea class="form-control" name="summary" id="summary" rows="2" th:text="${form.summary}"></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">ìƒì„¸</label>
      <textarea class="form-control" name="description" id="description" rows="2" th:text="${form.description}"></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">ì‘ì„±ì</label>
      <input class="form-control" name="author" id="author" th:value="${form.author}">
    </div>

    <div class="mb-3">
      <label class="form-label">ì¶œì‹œì¼</label>
      <input type="date" class="form-control" name="releaseDate" id="releaseDate" th:value="${form.releaseDate}">
    </div>

    <!-- âœ… ì¸ë„¤ì¼: URL ì§ì ‘ ì…ë ¥ + íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="mb-3">
      <label class="form-label">ì¸ë„¤ì¼</label>

      <div class="input-group mb-2">
        <input class="form-control" name="thumbnail" id="thumbnail" placeholder="https://... ë˜ëŠ” ì—…ë¡œë“œ"
               th:value="${form.thumbnail}">
        <button type="button" class="btn btn-outline-secondary" id="btnThumbPreview">ë¯¸ë¦¬ë³´ê¸°</button>
        <button type="button" class="btn btn-outline-danger" id="btnThumbClear">ì§€ìš°ê¸°</button>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <input type="file" class="form-control" id="thumbnailFile" accept="image/*">
        <button type="button" class="btn btn-primary" id="btnUploadThumb">ì—…ë¡œë“œ</button>
      </div>

      <div class="form-text">
        URLì„ ì§ì ‘ ì…ë ¥í•´ë„ ë˜ê³ , íŒŒì¼ ì—…ë¡œë“œí•˜ë©´ URLì´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.
      </div>

      <div class="mt-2" style="max-width: 420px;">
        <img id="thumbPreview" src="" alt="thumbnail preview"
             style="display:none; width:100%; border-radius:8px; border:1px solid #e5e7eb;">
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">ë§í¬</label>
      <input class="form-control" name="link" id="link" placeholder="https://..." th:value="${form.link}">
    </div>

    <div class="mb-3">
      <label class="form-label">Publisher</label>

      <select class="form-select" name="publisherId" id="publisherId" required>
        <option value="" th:selected="${form.publisher == null}">ì„ íƒ</option>
        <option th:each="e : ${publishers.entrySet()}"
                th:value="${e.key}"
                th:text="${e.value}"
                th:selected="${form.publisher != null and form.publisher.id == e.key}">
        </option>
      </select>

      <div class="form-text">ì €ì¥ê°’ì€ Publisher ID ì…ë‹ˆë‹¤.</div>
    </div>

    <div class="mb-3">
      <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
      <select class="form-select" name="category" id="category">
        <option value="" th:selected="${form.category == null}">ì„ íƒ</option>
        <option value="news"      th:selected="${form.category != null and form.category.type == 'news'}">news</option>
        <option value="event"     th:selected="${form.category != null and form.category.type == 'event'}">event</option>
        <option value="interview" th:selected="${form.category != null and form.category.type == 'interview'}">interview</option>
        <option value="publicity" th:selected="${form.category != null and form.category.type == 'publicity'}">publicity</option>
        <option value="editorial" th:selected="${form.category != null and form.category.type == 'editorial'}">editorial</option>
      </select>
    </div>

    <div class="mb-2">
      <label class="form-label">ë‚´ìš©</label>

      <!-- âœ… app.jsê°€ [data-summernote]ë¥¼ ìë™ init -->
      <textarea id="content"
                name="content"
                rows="12"
                class="form-control"
                data-summernote
                th:text="${form.content}"></textarea>

      <div class="form-text">
        ì´ë¯¸ì§€ ì‚½ì…ì€ ì €ì¥ ì‹œì ì— ì—…ë¡œë“œë©ë‹ˆë‹¤. (ì—ë””í„° ë‚´ë¶€ ë¯¸ë¦¬ë³´ê¸°ëŠ” blob)
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button type="button" class="btn btn-primary" id="btnSave"
              th:text="${mode == 'edit' ? 'ìˆ˜ì •' : 'ì €ì¥'}">ì €ì¥</button>
      <a class="btn btn-outline-secondary" th:href="@{/article/list}">ì·¨ì†Œ</a>
    </div>

    <div class="mt-3 text-danger" id="errorBox" style="display:none;"></div>
  </form>
</div>

<th:block th:replace="~{layout/footer :: footer}"></th:block>

<script th:inline="javascript">
  /*<![CDATA[*/
  // -------------------------
  // ì¸ë„¤ì¼ ìœ í‹¸
  // -------------------------
  function setThumbPreview(url) {
    const img = document.getElementById('thumbPreview');
    if (!img) return;
    if (!url) {
      img.style.display = 'none';
      img.src = '';
      return;
    }
    img.src = url;
    img.style.display = 'block';
  }

  async function uploadThumbnail() {
    const fileInput = document.getElementById('thumbnailFile');
    const file = fileInput?.files?.[0];
    if (!file) throw new Error('ì¸ë„¤ì¼ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

    const fd = new FormData();
    fd.append('file', file);

    // ğŸ” CSRFë¥¼ ì“°ê³  ìˆë‹¤ë©´ ì—¬ê¸°ì„œ í—¤ë” ì¶”ê°€
    // const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
    // const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;

    const res = await fetch('/api/upload/thumbnail', {
      method: 'POST',
      body: fd,
      // headers: csrfHeader && csrfToken ? { [csrfHeader]: csrfToken } : {}
    });

    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();

    const url = data.url;
    const thumbInput = document.getElementById('thumbnail');
    if (thumbInput) thumbInput.value = url;
    setThumbPreview(url);

    // ì—…ë¡œë“œ ì„±ê³µ í›„ íŒŒì¼ ì„ íƒê°’ ì´ˆê¸°í™”
    fileInput.value = '';
  }

  // -------------------------
  // ì €ì¥ URL
  // -------------------------
  function getSaveUrl() {
    const mode = document.getElementById('mode')?.value || 'create';
    const articleId = document.getElementById('articleId')?.value;

    if (mode === 'edit' && articleId && articleId !== 'null' && articleId !== 'undefined' && articleId !== '') {
      return `/article/save?id=${encodeURIComponent(articleId)}`;
    }
    return '/article/save';
  }

  // -------------------------
  // í™”ë©´ ë°”ì¸ë”©
  // -------------------------
  document.addEventListener('DOMContentLoaded', () => {
    const errorBox = document.getElementById('errorBox');
    const btnSave = document.getElementById('btnSave');
    const formEl = document.getElementById('articleForm');

    const thumbInput = document.getElementById('thumbnail');
    const btnThumbPreview = document.getElementById('btnThumbPreview');
    const btnThumbClear = document.getElementById('btnThumbClear');
    const btnUploadThumb = document.getElementById('btnUploadThumb');

    // ì´ˆê¸° ì¸ë„¤ì¼ í”„ë¦¬ë·°
    const initialThumb = thumbInput?.value?.trim();
    if (initialThumb) setThumbPreview(initialThumb);

    btnThumbPreview?.addEventListener('click', () => {
      const url = (thumbInput?.value ?? '').toString().trim();
      setThumbPreview(url);
    });

    btnThumbClear?.addEventListener('click', () => {
      if (thumbInput) thumbInput.value = '';
      setThumbPreview('');
    });

    btnUploadThumb?.addEventListener('click', async () => {
      if (errorBox) { errorBox.style.display = 'none'; errorBox.textContent = ''; }
      btnUploadThumb.disabled = true;
      const original = btnUploadThumb.textContent;
      btnUploadThumb.textContent = 'ì—…ë¡œë“œ ì¤‘...';

      try {
        await uploadThumbnail();
      } catch (e) {
        console.error(e);
        if (errorBox) {
          errorBox.style.display = 'block';
          errorBox.textContent = 'ì¸ë„¤ì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (e?.message ?? e);
        }
      } finally {
        btnUploadThumb.disabled = false;
        btnUploadThumb.textContent = original;
      }
    });

    // í¼ submit ê¸°ë³¸ ë™ì‘ ë°©ì§€
    formEl?.addEventListener('submit', (e) => e.preventDefault());

    // ì €ì¥
    btnSave?.addEventListener('click', async () => {
      if (errorBox) { errorBox.style.display = 'none'; errorBox.textContent = ''; }

      const formData = new FormData(formEl);

      // âœ… app.jsê°€ ê´€ë¦¬í•˜ëŠ” Summernote payload (content + files)
      const payload = window.getSummernotePayload({
        editorSelector: '#content'
      });

      formData.set('content', payload.content);
      for (const f of payload.files) formData.append('files', f);

      const saveUrl = getSaveUrl();

      btnSave.disabled = true;
      const originalText = btnSave.textContent;
      btnSave.textContent = 'ì €ì¥ ì¤‘...';

      try {
        const res = await fetch(saveUrl, { method: 'POST', body: formData });
        if (!res.ok) throw new Error(await res.text());

        const data = await res.json();
        window.location.href = `/article/detail?id=${data.id}`;
      } catch (e) {
        console.error(e);
        if (errorBox) {
          errorBox.style.display = 'block';
          errorBox.textContent = 'ì €ì¥ ì‹¤íŒ¨: ' + (e?.message ?? e);
        }
      } finally {
        btnSave.disabled = false;
        btnSave.textContent = originalText;
      }
    });
  });
  /*]]>*/
</script>

</body>
</html>
