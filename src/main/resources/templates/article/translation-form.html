<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout/head :: head}"></th:block>
<style>
    .card-soft {
        border: 1px solid rgba(0,0,0,.08);
        box-shadow: 0 10px 24px rgba(0,0,0,.06);
        border-radius: 16px;
    }
    .form-readonly input[readonly],
    .form-readonly textarea[readonly]{
        background: #f8f9fa !important;
        cursor: not-allowed;
    }
    .mono-badge {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
</style>
<body class="bg-light">
<th:block th:replace="~{layout/header :: header}"></th:block>
<div class="container py-4">

    <!-- ìƒë‹¨ -->
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-3">
        <div>
            <h4 class="mb-1">ë²ˆì—­ ê´€ë¦¬</h4>
            <div class="text-muted small">
                Article ID: <span th:text="${article.id}" class="mono-badge">0</span> Â·
                í˜„ì¬ ì–¸ì–´: <span class="badge text-bg-dark mono-badge" th:text="${lang}">en</span>
            </div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
            <!-- ì–¸ì–´ ì„ íƒ -->
            <select class="form-select" style="min-width:180px"
                    id="langSelect" th:data-article-id="${article.id}">
                <option th:each="l : ${langs}"
                        th:value="${l}"
                        th:selected="${l == lang}"
                        th:text="${l}">en</option>
            </select>

            <!-- ìƒíƒœ -->
            <span class="badge"
                  th:classappend="${translation.id != null} ? ' text-bg-success' : ' text-bg-secondary'">
        <span th:text="${translation.id != null} ? 'ë²ˆì—­ ìˆìŒ' : 'ë²ˆì—­ ì—†ìŒ'">ë²ˆì—­ ìˆìŒ</span>
        <span th:if="${translation.id != null}"> Â· #<span th:text="${translation.id}">1</span></span>
      </span>

            <a class="btn btn-outline-secondary" th:href="@{/article/detail(id=${article.id})}">
                â† ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>

    <div class="row g-3">

        <!-- ì¢Œ: ì›ë¬¸ -->
        <div class="col-12 col-lg-6">
            <div class="card card-soft">
                <div class="card-header bg-white d-flex align-items-start justify-content-between">
                    <div>
                        <div class="fw-semibold">ì›ë¬¸(Article)</div>
                        <div class="text-muted small">ì½ê¸° ì „ìš©</div>
                    </div>

                    <span class="badge text-bg-light border"
                          th:if="${article.publisher != null}">
            Publisher: <span class="mono-badge" th:text="${article.publisher.name}">Publisher</span>
          </span>
                </div>

                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Title</label>
                            <input class="form-control" th:value="${article.title}" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Author</label>
                            <input class="form-control" th:value="${article.author}" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Category</label>
                            <input class="form-control" th:value="${article.category}" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Release Date</label>
                            <input class="form-control" th:value="${article.releaseDate}" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Thumbnail</label>
                            <input class="form-control" th:value="${article.thumbnail}" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Link</label>
                            <input class="form-control" th:value="${article.link}" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Description</label>
                            <textarea class="form-control" rows="3" readonly th:text="${article.description}"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Summary</label>
                            <textarea class="form-control" rows="3" readonly th:text="${article.summary}"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Content</label>
                            <textarea class="form-control" rows="8" readonly th:text="${article.content}"></textarea>
                        </div>
                    </div>

                    <div class="text-muted small mt-2">
                        * ì›ë¬¸ ìˆ˜ì •ì€ Article ìˆ˜ì • í™”ë©´ì—ì„œ ì§„í–‰.
                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°: ë²ˆì—­ -->
        <div class="col-12 col-lg-6">
            <div class="card card-soft">
                <div class="card-header bg-white d-flex align-items-start justify-content-between">
                    <div>
                        <div class="fw-semibold">
                            ë²ˆì—­(Translation) Â· <span class="badge text-bg-dark mono-badge" th:text="${lang}">en</span>
                        </div>
                        <div class="text-muted small">
              <span th:text="${translation.id != null} ? 'ê¸°ì¡´ ë²ˆì—­: ì ê¸ˆ ìƒíƒœ (ìˆ˜ì • ë²„íŠ¼ í•„ìš”)' : 'ìƒˆ ë²ˆì—­: ë°”ë¡œ ì‘ì„± ê°€ëŠ¥'">
                ìƒˆ ë²ˆì—­
              </span>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <!-- âœ… 1) ë²ˆì—­ì´ ìˆìœ¼ë©´ ìˆ˜ì • ë²„íŠ¼ í•„ìš” -->
                        <button type="button"
                                class="btn btn-outline-primary"
                                id="editBtn"
                                th:if="${translation.id != null}"
                                onclick="enableEdit()">
                            âœï¸ ìˆ˜ì •
                        </button>

                        <!-- ì €ì¥: ë²ˆì—­ ìˆìœ¼ë©´ ê¸°ë³¸ disabled -->
                        <button type="button" class="btn btn-primary" id="saveProxyBtn" onclick="submitTranslation()">
                            ğŸ’¾ ì €ì¥
                        </button>
                    </div>
                </div>

                <div class="card-body">

                    <form id="translationForm"
                          th:action="@{|/article/translate/${article.id}|}"
                          method="post"
                          th:object="${translation}"
                          class="form-readonly">

                        <!-- hidden -->
                        <input type="hidden" th:field="*{id}">
                        <input type="hidden" th:field="*{languageCode}">

                        <div id="translationSection" class="row g-2">
                            <div class="col-12 col-md-6">
                                <label class="form-label small text-muted">Title</label>
                                <input class="form-control"
                                       th:field="*{title}"
                                       th:attr="readonly=${translation.id != null} ? 'readonly' : null">
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label small text-muted">Author</label>
                                <input class="form-control"
                                       th:field="*{author}"
                                       th:attr="readonly=${translation.id != null} ? 'readonly' : null">
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted">Description</label>
                                <textarea class="form-control" rows="3"
                                          th:field="*{description}"
                                          th:attr="readonly=${translation.id != null} ? 'readonly' : null"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted">Summary</label>
                                <textarea class="form-control" rows="3"
                                          th:field="*{summary}"
                                          th:attr="readonly=${translation.id != null} ? 'readonly' : null"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted">Content</label>
                                <textarea class="form-control" rows="8"
                                          th:field="*{content}"
                                          th:attr="readonly=${translation.id != null} ? 'readonly' : null"></textarea>
                            </div>
                        </div>

                        <!-- ì‹¤ì œ submit ë²„íŠ¼ì€ ìˆ¨ê¸°ê³ , ìƒë‹¨ ì €ì¥ ë²„íŠ¼ì´ íŠ¸ë¦¬ê±° -->
                        <button type="submit" id="realSubmitBtn" class="d-none">submit</button>

                        <div class="alert alert-warning mt-3 mb-0"
                             id="lockHint"
                             th:if="${translation.id != null}">
                            í˜„ì¬ ë²ˆì—­ì€ ì ê²¨ ìˆì–´ìš”. <b>ìˆ˜ì •</b>ì„ ëˆ„ë¥¸ í›„ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.
                        </div>

                        <div class="alert alert-info mt-3 mb-0"
                             th:if="${translation.id == null}">
                            ì‹ ê·œ ë²ˆì—­ ì‘ì„±
                        </div>
                    </form>

                </div>
            </div>
        </div>

    </div>
</div>
<th:block th:replace="~{layout/footer :: footer}"></th:block>
<script>
    // ì–¸ì–´ ë³€ê²½ -> ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ìœ ì§€í•˜ë©´ì„œ ì´ë™
    (function () {
        const sel = document.getElementById('langSelect');
        if (!sel) return;
        sel.addEventListener('change', () => {
            const articleId = sel.dataset.articleId;
            const lang = sel.value;
            window.location.href = `/article/translate/${articleId}?lang=${encodeURIComponent(lang)}`;
        });
    })();

    // âœ… 1) "ìˆ˜ì • ì „ ì €ì¥ disabled" êµ¬í˜„:
    // - ê¸°ì¡´ ë²ˆì—­(translation.id != null)ì¸ ê²½ìš°: ì ê¸ˆ ìƒíƒœì—ì„œëŠ” ì €ì¥ ë¶ˆê°€
    // - ìƒˆ ë²ˆì—­ì´ë©´: ë°”ë¡œ ì €ì¥ ê°€ëŠ¥
    const isExistingTranslation = /*[[${translation.id != null}]]*/ false;
    let editUnlocked = !isExistingTranslation;

    const saveProxyBtn = document.getElementById('saveProxyBtn');
    const lockHint = document.getElementById('lockHint');

    function refreshSaveState() {
        if (!saveProxyBtn) return;
        if (editUnlocked) {
            saveProxyBtn.classList.remove('disabled');
            saveProxyBtn.removeAttribute('aria-disabled');
            saveProxyBtn.style.pointerEvents = '';
            if (lockHint) lockHint.classList.add('d-none');
        } else {
            saveProxyBtn.classList.add('disabled');
            saveProxyBtn.setAttribute('aria-disabled', 'true');
            saveProxyBtn.style.pointerEvents = 'none';
            if (lockHint) lockHint.classList.remove('d-none');
        }
    }

    refreshSaveState();

    function enableEdit() {
        // ë²ˆì—­ ì„¹ì…˜ë§Œ unlock
        document.querySelectorAll('#translationSection input[readonly], #translationSection textarea[readonly]')
            .forEach(el => el.removeAttribute('readonly'));

        // ì ê¸ˆ ìƒíƒœ í•´ì œ
        editUnlocked = true;
        refreshSaveState();

        const first = document.querySelector('#translationSection input, #translationSection textarea');
        if (first) first.focus();
    }

    function submitTranslation() {
        if (!editUnlocked) return;
        const real = document.getElementById('realSubmitBtn');
        if (real) real.click();
    }
</script>

</body>
</html>
