<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout/head :: head}"></th:block>

<style>
    .card-soft {
        border: 1px solid rgba(0,0,0,.08);
        box-shadow: 0 10px 24px rgba(0,0,0,.06);
        border-radius: 16px;
    }
    .form-readonly input[readonly],
    .form-readonly textarea[readonly]{
        background: #f8f9fa !important;
        cursor: not-allowed;
    }
    .mono-badge {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .preview-box img { max-width: 100%; height: auto; }
    .preview-box table { width: 100%; }
    .preview-box { background: #fff; border: 1px solid rgba(0,0,0,.12); border-radius: 12px; padding: 12px; }

    /* Summernoteê°€ textareaë¥¼ ë…¸ì¶œì‹œí‚¤ëŠ” ìƒí™© ëŒ€ë¹„(ì´ˆê¸° ê¹œë¹¡ì„ ë°©ì§€) */
    #summernote { visibility: hidden; }
    .note-editor { visibility: visible; }
</style>

<body class="bg-light">
<th:block th:replace="~{layout/header :: header}"></th:block>

<div class="container py-4">

    <!-- ìƒë‹¨ -->
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-3">
        <div>
            <h4 class="mb-1">ë²ˆì—­ ê´€ë¦¬</h4>
            <div class="text-muted small">
                Article ID: <span th:text="${article.id}" class="mono-badge">0</span> Â·
                í˜„ì¬ ì–¸ì–´: <span class="badge text-bg-dark mono-badge" th:text="${lang}">en</span>
            </div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
            <!-- ìƒíƒœ -->
            <span class="badge"
                  th:classappend="${translation.id != null} ? ' text-bg-success' : ' text-bg-secondary'">
                <span th:text="${translation.id != null} ? 'ë²ˆì—­ ìˆìŒ' : 'ë²ˆì—­ ì—†ìŒ'">ë²ˆì—­ ìˆìŒ</span>
                <span th:if="${translation.id != null}"> Â· #<span th:text="${translation.id}">1</span></span>
            </span>

            <a class="btn btn-outline-secondary" th:href="@{/article/detail(id=${article.id})}">
                â† ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>

    <div class="row g-3">

        <!-- ì¢Œ: ì›ë¬¸ -->
        <div class="col-12 col-lg-6">
            <div class="card card-soft">
                <div class="card-header bg-white d-flex align-items-start justify-content-between">
                    <div>
                        <div class="fw-semibold">ì›ë¬¸(Article)</div>
                        <div class="text-muted small">ì½ê¸° ì „ìš©</div>
                    </div>

                    <span class="badge text-bg-light border"
                          th:if="${article.publisher != null}">
                        Publisher: <span class="mono-badge" th:text="${article.publisher.name}">Publisher</span>
                    </span>
                </div>

                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Title</label>
                            <input class="form-control" th:value="${article.title}" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Author</label>
                            <input class="form-control" th:value="${article.author}" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Category</label>
                            <input class="form-control" th:value="${article.category}" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Release Date</label>
                            <input class="form-control" th:value="${article.releaseDate}" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Thumbnail</label>
                            <input class="form-control" th:value="${article.thumbnail}" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Link</label>
                            <input class="form-control" th:value="${article.link}" readonly>
                        </div>

                        <div class="col-12">
                            <label class="form-label small text-muted">Description</label>
                            <textarea class="form-control" rows="3" readonly th:text="${article.description}"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Summary</label>
                            <textarea class="form-control" rows="3" readonly th:text="${article.summary}"></textarea>
                        </div>

                        <div class="col-12">
                            <label class="form-label small text-muted">Content (Preview)</label>
                            <div class="preview-box" th:utext="${article.content}"></div>
                        </div>
                    </div>

                    <div class="text-muted small mt-2">
                        * ì›ë¬¸ ìˆ˜ì •ì€ Article ìˆ˜ì • í™”ë©´ì—ì„œ ì§„í–‰.
                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°: ë²ˆì—­ -->
        <div class="col-12 col-lg-6">
            <div class="card card-soft">
                <div class="card-header bg-white d-flex align-items-start justify-content-between">
                    <div>
                        <div class="fw-semibold">
                            ë²ˆì—­(Translation) Â· <span class="badge text-bg-dark mono-badge" th:text="${lang}">en</span>
                        </div>
                        <div class="text-muted small">
                            <span th:text="${translation.id != null} ? 'ê¸°ì¡´ ë²ˆì—­: ì ê¸ˆ ìƒíƒœ (ìˆ˜ì • ë²„íŠ¼ í•„ìš”)' : 'ìƒˆ ë²ˆì—­: ì›ë¬¸ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ í‘œì‹œ'">
                                ìƒˆ ë²ˆì—­
                            </span>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button"
                                class="btn btn-outline-primary"
                                id="editBtn"
                                th:if="${translation.id != null}"
                                onclick="enableEdit()">
                            âœï¸ ìˆ˜ì •
                        </button>

<!--                        <button type="button" class="btn btn-primary" id="saveProxyBtn" onclick="submitTranslation()">-->
<!--                            ğŸ’¾ ì €ì¥-->
<!--                        </button>-->
                    </div>
                </div>

                <div class="card-body">

                    <form id="translationForm"
                          th:action="@{|/article/translate/${article.id}|}"
                          method="post"
                          enctype="multipart/form-data"
                          th:object="${translation}"
                          class="form-readonly">

                        <!-- hidden -->
                        <input type="hidden" th:field="*{id}">
                        <input type="hidden" th:field="*{languageCode}">
                        <input type="hidden" name="lang" th:value="${lang}">

                        <div id="translationSection" class="row g-2">
                            <div class="col-12 col-md-6">
                                <label class="form-label small text-muted">Title</label>
                                <input class="form-control"
                                       th:field="*{title}"
                                       th:value="${translation.id == null ? article.title : translation.title}"
                                       th:attr="readonly=${translation.id != null} ? 'readonly' : null">
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label small text-muted">Author</label>
                                <input class="form-control"
                                       th:field="*{author}"
                                       th:value="${translation.id == null ? article.author : translation.author}"
                                       th:attr="readonly=${translation.id != null} ? 'readonly' : null">
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted">Description</label>
                                <textarea class="form-control" rows="3"
                                          th:field="*{description}"
                                          th:text="${translation.id == null ? article.description : translation.description}"
                                          th:attr="readonly=${translation.id != null} ? 'readonly' : null"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted">Summary</label>
                                <textarea class="form-control" rows="3"
                                          th:field="*{summary}"
                                          th:text="${translation.id == null ? article.summary : translation.summary}"
                                          th:attr="readonly=${translation.id != null} ? 'readonly' : null"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted">Content</label>

                                <!-- Preview -->
                                <div id="translationPreviewBox"
                                     class="preview-box"
                                     th:utext="${translation.id == null ? article.content : translation.content}"
                                     th:style="${translation.id == null} ? 'display:none;' : ''">
                                </div>

                                <!-- Editor -->
                                <div id="translationEditorBox"
                                     class="mt-2"
                                     th:style="${translation.id != null} ? 'display:none;' : ''">
                                    <!-- âœ… summernoteëŠ” ë”± í•˜ë‚˜ë§Œ -->
                                    <textarea id="summernote"></textarea>
                                </div>
                                <!-- âœ… ì„œë²„ ì œì¶œìš© (ì´ˆê¸°ê°’ì€ JSê°€ ì±„ì›€) -->
                                <input type="hidden" name="content" id="contentHidden">
                            </div>

                        </div>

                        <!-- âœ… ë²ˆì—­ í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ -->
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <!-- ì‹ ê·œëŠ” í•­ìƒ ì €ì¥ ê°€ëŠ¥ -->
                            <button type="button"
                                    class="btn btn-primary"
                                    id="saveProxyBtn"
                                    onclick="submitTranslation()">
                                ğŸ’¾ ì €ì¥
                            </button>

                            <!-- âœ… ì·¨ì†ŒëŠ” "ìˆ˜ì • ëª¨ë“œ"ì—ì„œë§Œ í‘œì‹œ -->
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    id="cancelBtn"
                                    style="display:none;"
                                    onclick="cancelEdit()">
                                âœ–ï¸ ì·¨ì†Œ
                            </button>
                        </div>


                        <div class="alert alert-warning mt-3 mb-0"
                             id="lockHint"
                             th:if="${translation.id != null}">
                            í˜„ì¬ ë²ˆì—­ì€ ì ê²¨ ìˆì–´ìš”. <b>ìˆ˜ì •</b>ì„ ëˆ„ë¥¸ í›„ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.
                        </div>

                        <div class="alert alert-info mt-3 mb-0"
                             th:if="${translation.id == null}">
                            ì‹ ê·œ ë²ˆì—­ ì‘ì„±: ê¸°ë³¸ê°’ìœ¼ë¡œ ì›ë¬¸ì´ ì±„ì›Œì ¸ ìˆì–´ìš”. ìˆ˜ì • í›„ ì €ì¥í•˜ë©´ ë²ˆì—­ì´ ìƒì„±ë©ë‹ˆë‹¤.
                        </div>
                    </form>

                </div>
            </div>
        </div>

    </div>
</div>

<th:block th:replace="~{layout/footer :: footer}"></th:block>

<script th:inline="javascript">
    const isExistingTranslation = /*[[${translation.id != null}]]*/ false;

    // âœ… ì´ˆê¸° contentë¥¼ â€œJS ë¬¸ìì—´â€ë¡œ ì§ì ‘ ì£¼ì… (ê°€ì¥ ì•ˆì •ì )
    const initialContent = /*[[${translation.id == null ? article.content : translation.content}]]*/ "";

    let editUnlocked = !isExistingTranslation;

    const saveProxyBtn = document.getElementById('saveProxyBtn');
    const lockHint = document.getElementById('lockHint');

    const previewBox = document.getElementById('translationPreviewBox');
    const editorBox  = document.getElementById('translationEditorBox');
    const contentHidden = document.getElementById('contentHidden');

    const cancelBtn = document.getElementById('cancelBtn');
    const editBtn = document.getElementById('editBtn');


    function refreshSaveState() {
        if (!saveProxyBtn) return;
        if (editUnlocked) {
            saveProxyBtn.classList.remove('disabled');
            saveProxyBtn.style.pointerEvents = '';
            if (lockHint) lockHint.classList.add('d-none');
        } else {
            saveProxyBtn.classList.add('disabled');
            saveProxyBtn.style.pointerEvents = 'none';
            if (lockHint) lockHint.classList.remove('d-none');
        }
    }
    refreshSaveState();

    // ===== ì´ë¯¸ì§€ ë¡œì§(ê·¸ëŒ€ë¡œ) =====
    const pendingFiles = new Map();
    function generateAssetId() {
        const rnd = Math.random().toString(16).slice(2);
        return `asset_${Date.now()}_${rnd}`;
    }
    function fileExtFromMime(file) {
        const type = (file && file.type) ? file.type.toLowerCase() : '';
        if (type.includes('png')) return 'png';
        if (type.includes('jpeg') || type.includes('jpg')) return 'jpg';
        if (type.includes('gif')) return 'gif';
        if (type.includes('webp')) return 'webp';
        return 'png';
    }
    function insertImageWithAssetId(file) {
        const assetId = generateAssetId();
        const ext = fileExtFromMime(file);
        const filename = `${assetId}.${ext}`;
        const renamed = new File([file], filename, { type: file.type });
        pendingFiles.set(assetId, renamed);

        const objectUrl = URL.createObjectURL(renamed);
        const imgHtml = `<img src="${objectUrl}" data-asset-id="${assetId}" />`;
        $('#summernote').summernote('pasteHTML', imgHtml);
    }

    // ===== Summernote init =====
    let summernoteReady = false;

    function initSummernote(html) {
        if (!window.jQuery || !$('#summernote').summernote) {
            console.warn('Summernote not loaded (check head includes)');
            return;
        }

        // ì´ë¯¸ initë˜ì–´ ìˆìœ¼ë©´ ì¬ì‚¬ìš©
        if (!summernoteReady) {
            $('#summernote').summernote({
                height: 320,
                callbacks: {
                    onChange: function(contents) {
                        if (contentHidden) contentHidden.value = contents;
                    },
                    onImageUpload: function(files) {
                        if (!editUnlocked) return;
                        if (!files || !files.length) return;
                        for (const f of files) insertImageWithAssetId(f);
                    }
                }
            });
            summernoteReady = true;
        }

        $('#summernote').summernote('code', html || '');
        $('#summernote').summernote(editUnlocked ? 'enable' : 'disable');

        // ì œì¶œ hiddenì—ë„ ë™ê¸°í™”
        if (contentHidden) contentHidden.value = $('#summernote').summernote('code');
    }

    // âœ… ì‹ ê·œ: ì²˜ìŒë¶€í„° editor ëª¨ë“œ + ì›ë¬¸ ì£¼ì… + ë°”ë¡œ í¸ì§‘ ê°€ëŠ¥
    window.addEventListener('DOMContentLoaded', () => {
        if (!isExistingTranslation) {
            editUnlocked = true;
            refreshSaveState();

            if (previewBox) previewBox.style.display = 'none';
            if (editorBox) editorBox.style.display = '';

            // â€œë³´ì´ëŠ” ìƒíƒœâ€ ë³´ì¥ í›„ init
            requestAnimationFrame(() => initSummernote(initialContent));
        } else {
            // ê¸°ì¡´ì€ previewë§Œ, hidden ì œì¶œê°’ë§Œ ì„¸íŒ…
            if (contentHidden) contentHidden.value = initialContent;
        }
    });

    // âœ… ê¸°ì¡´: ìˆ˜ì • ëˆ„ë¥´ë©´ preview ìˆ¨ê¸°ê³  editor ë³´ì—¬ì£¼ê³  init + ë²ˆì—­ ì£¼ì…
    function enableEdit() {
        document.querySelectorAll('#translationSection input[readonly], #translationSection textarea[readonly]')
            .forEach(el => el.removeAttribute('readonly'));

        editUnlocked = true;
        refreshSaveState();

        if (cancelBtn) cancelBtn.style.display = '';   // âœ… ìˆ˜ì •ëª¨ë“œì—ì„œë§Œ ë³´ì´ê¸°
        if (editBtn) editBtn.style.display = 'none';   // âœ… ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¸°ê¸°(ì›í•˜ë©´)

        if (previewBox) previewBox.style.display = 'none';
        if (editorBox) editorBox.style.display = '';

        requestAnimationFrame(() => {
            initSummernote(contentHidden?.value || initialContent);
            $('#summernote').summernote('focus');
        });


    }
    window.enableEdit = enableEdit;

    function cancelEdit() {
        // ê¸°ì¡´ ë²ˆì—­ì—ì„œë§Œ ë™ì‘í•˜ë„ë¡
        if (!isExistingTranslation) return;

        // pendingFiles ì •ë¦¬
        pendingFiles.clear();

        // content ì›ë³µ
        if (contentHidden) contentHidden.value = initialContent;
        if (previewBox) previewBox.innerHTML = initialContent;

        // summernote ì›ë³µ + disable
        if (summernoteReady && window.jQuery && $('#summernote').summernote) {
            $('#summernote').summernote('code', initialContent);
            $('#summernote').summernote('disable');
        }

        // ëª¨ë“œ ì „í™˜: Editor -> Preview
        if (editorBox) editorBox.style.display = 'none';
        if (previewBox) previewBox.style.display = '';
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (editBtn) editBtn.style.display = ''; // ë‹¤ì‹œ ìˆ˜ì •ë²„íŠ¼ ë³´ì´ê²Œ(ì›í•˜ë©´)

        editUnlocked = false;
        refreshSaveState();

        // readonly ë³µêµ¬(í•„ìš”ì‹œ)
        document.querySelectorAll('#translationSection input, #translationSection textarea')
            .forEach(el => el.setAttribute('readonly', 'readonly'));
    }
    window.cancelEdit = cancelEdit;


    async function submitTranslation() {
        if (!editUnlocked) return;

        // ìµœì¢… ë™ê¸°í™”
        if (summernoteReady && window.jQuery && $('#summernote').summernote) {
            const html = $('#summernote').summernote('code');
            if (contentHidden) contentHidden.value = html;
        }

        const form = document.getElementById('translationForm');
        const fd = new FormData(form);

        for (const [, file] of pendingFiles.entries()) {
            fd.append('files', file, file.name);
        }

        const res = await fetch(form.action, { method: 'POST', body: fd });
        if (res.redirected) { window.location.href = res.url; return; }
        if (res.ok) { window.location.reload(); return; }
        alert('ì €ì¥ ì‹¤íŒ¨: ' + res.status);
    }
    window.submitTranslation = submitTranslation;
</script>

</body>
</html>
