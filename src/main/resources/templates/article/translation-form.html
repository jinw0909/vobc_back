<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout/head :: head}"></th:block>

<style>
    .card-soft {
        border: 1px solid rgba(0,0,0,.08);
        box-shadow: 0 10px 24px rgba(0,0,0,.06);
        border-radius: 16px;
    }
    .form-readonly input[readonly],
    .form-readonly textarea[readonly]{
        background: #f8f9fa !important;
        cursor: not-allowed;
    }
    .mono-badge {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .preview-box img { max-width: 100%; height: auto; }
    .preview-box table { width: 100%; }
    .preview-box { background: #fff; border: 1px solid rgba(0,0,0,.12); border-radius: 12px; padding: 12px; }
</style>

<body class="bg-light">
<th:block th:replace="~{layout/header :: header}"></th:block>

<div class="container py-4">

    <!-- ìƒë‹¨ -->
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-3">
        <div>
            <h4 class="mb-1">ë²ˆì—­ ê´€ë¦¬</h4>
            <div class="text-muted small">
                Article ID: <span th:text="${article.id}" class="mono-badge">0</span> Â·
                í˜„ì¬ ì–¸ì–´: <span class="badge text-bg-dark mono-badge" th:text="${lang}">en</span>
            </div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
            <!-- ìƒíƒœ -->
            <span class="badge"
                  th:classappend="${translation.id != null} ? ' text-bg-success' : ' text-bg-secondary'">
                <span th:text="${translation.id != null} ? 'ë²ˆì—­ ìˆìŒ' : 'ë²ˆì—­ ì—†ìŒ'">ë²ˆì—­ ìˆìŒ</span>
                <span th:if="${translation.id != null}"> Â· #<span th:text="${translation.id}">1</span></span>
            </span>

            <a class="btn btn-outline-secondary" th:href="@{/article/detail(id=${article.id})}">
                â† ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>

    <div class="row g-3">

        <!-- ì¢Œ: ì›ë¬¸ -->
        <div class="col-12 col-lg-6">
            <div class="card card-soft">
                <div class="card-header bg-white d-flex align-items-start justify-content-between">
                    <div>
                        <div class="fw-semibold">ì›ë¬¸(Article)</div>
                        <div class="text-muted small">ì½ê¸° ì „ìš©</div>
                    </div>

                    <span class="badge text-bg-light border"
                          th:if="${article.publisher != null}">
                        Publisher: <span class="mono-badge" th:text="${article.publisher.name}">Publisher</span>
                    </span>
                </div>

                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Title</label>
                            <input class="form-control" th:value="${article.title}" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Author</label>
                            <input class="form-control" th:value="${article.author}" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Category</label>
                            <input class="form-control" th:value="${article.category}" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Release Date</label>
                            <input class="form-control" th:value="${article.releaseDate}" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Thumbnail</label>
                            <input class="form-control" th:value="${article.thumbnail}" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Link</label>
                            <input class="form-control" th:value="${article.link}" readonly>
                        </div>

                        <div class="col-12">
                            <label class="form-label small text-muted">Description</label>
                            <textarea class="form-control" rows="3" readonly th:text="${article.description}"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Summary</label>
                            <textarea class="form-control" rows="3" readonly th:text="${article.summary}"></textarea>
                        </div>

                        <div class="col-12">
                            <label class="form-label small text-muted">Content (Preview)</label>
                            <div class="preview-box" th:utext="${article.content}"></div>
                        </div>
                    </div>

                    <div class="text-muted small mt-2">
                        * ì›ë¬¸ ìˆ˜ì •ì€ Article ìˆ˜ì • í™”ë©´ì—ì„œ ì§„í–‰.
                    </div>
                </div>
            </div>
        </div>

        <!-- ìš°: ë²ˆì—­ -->
        <div class="col-12 col-lg-6">
            <div class="card card-soft">
                <div class="card-header bg-white d-flex align-items-start justify-content-between">
                    <div>
                        <div class="fw-semibold">
                            ë²ˆì—­(Translation) Â· <span class="badge text-bg-dark mono-badge" th:text="${lang}">en</span>
                        </div>
                        <div class="text-muted small">
                            <span th:text="${translation.id != null} ? 'ê¸°ì¡´ ë²ˆì—­: ì ê¸ˆ ìƒíƒœ (ìˆ˜ì • ë²„íŠ¼ í•„ìš”)' : 'ìƒˆ ë²ˆì—­: ì›ë¬¸ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ í‘œì‹œ'">
                                ìƒˆ ë²ˆì—­
                            </span>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button"
                                class="btn btn-outline-primary"
                                id="editBtn"
                                th:if="${translation.id != null}">
                            âœï¸ ìˆ˜ì •
                        </button>

<!--                        <button type="button" class="btn btn-primary" id="saveProxyBtn" onclick="submitTranslation()">-->
<!--                            ğŸ’¾ ì €ì¥-->
<!--                        </button>-->
                    </div>
                </div>

                <div class="card-body">

                    <form id="translationForm"
                          th:action="@{|/article/translate/${article.id}|}"
                          method="post"
                          enctype="multipart/form-data"
                          th:object="${translation}"
                          class="form-readonly">

                        <!-- hidden -->
                        <input type="hidden" th:field="*{id}">
                        <input type="hidden" th:field="*{languageCode}">
                        <input type="hidden" name="lang" th:value="${lang}">

                        <div id="translationSection" class="row g-2">
                            <div class="col-12 col-md-6">
                                <label class="form-label small text-muted">Title</label>
                                <input class="form-control"
                                       th:field="*{title}"
                                       th:value="${translation.id == null ? article.title : translation.title}"
                                       th:attr="readonly=${translation.id != null} ? 'readonly' : null">
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label small text-muted">Author</label>
                                <input class="form-control"
                                       th:field="*{author}"
                                       th:value="${translation.id == null ? article.author : translation.author}"
                                       th:attr="readonly=${translation.id != null} ? 'readonly' : null">
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted">Description</label>
                                <textarea class="form-control" rows="3"
                                          th:field="*{description}"
                                          th:text="${translation.id == null ? article.description : translation.description}"
                                          th:attr="readonly=${translation.id != null} ? 'readonly' : null"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted">Summary</label>
                                <textarea class="form-control" rows="3"
                                          th:field="*{summary}"
                                          th:text="${translation.id == null ? article.summary : translation.summary}"
                                          th:attr="readonly=${translation.id != null} ? 'readonly' : null"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted">Content</label>

                                <!-- âœ… ë³´ê¸° ëª¨ë“œ -->
                                <div id="translatedContentView"
                                     class="preview-box"
                                     th:utext="${translation.id == null ? article.content : translation.content}"
                                     th:style="${translation.id == null} ? 'display:none;' : ''">
                                </div>

                                <!-- âœ… í¸ì§‘ ëª¨ë“œ(ì„œë¨¸ë…¸íŠ¸ textarea) -->
                                <div id="translatedContentEditorWrap"
                                     class="mt-2"
                                     th:style="${translation.id != null} ? 'display:none;' : ''">
                                     <textarea id="translatedContentEditor"
                                               class="form-control"
                                               style="display:none;"></textarea>
                                </div>

                                <!-- âœ… ì„œë²„ ì œì¶œìš© hidden (ì´ˆê¸°ê°’ì€ thymeleafë¡œ ì±„ìš°ê³ , JSê°€ ê³„ì† ê°±ì‹ ) -->
                                <input type="hidden" name="content" id="contentHidden"
                                       th:value="${translation.id == null ? article.content : translation.content}">
                            </div>

                        </div>

                        <!-- âœ… ë²ˆì—­ í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ -->
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <!-- ì‹ ê·œëŠ” í•­ìƒ ì €ì¥ ê°€ëŠ¥ -->
                            <button type="button"
                                    class="btn btn-primary"
                                    id="saveProxyBtn">
                                ğŸ’¾ ì €ì¥
                            </button>

                            <!-- âœ… ì·¨ì†ŒëŠ” "ìˆ˜ì • ëª¨ë“œ"ì—ì„œë§Œ í‘œì‹œ -->
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    id="cancelBtn"
                                    style="display:none;">
                                âœ–ï¸ ì·¨ì†Œ
                            </button>
                        </div>


                        <div class="alert alert-warning mt-3 mb-0"
                             id="lockHint"
                             th:if="${translation.id != null}">
                            í˜„ì¬ ë²ˆì—­ì€ ì ê²¨ ìˆì–´ìš”. <b>ìˆ˜ì •</b>ì„ ëˆ„ë¥¸ í›„ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.
                        </div>

                        <div class="alert alert-info mt-3 mb-0"
                             th:if="${translation.id == null}">
                            ì‹ ê·œ ë²ˆì—­ ì‘ì„±: ê¸°ë³¸ê°’ìœ¼ë¡œ ì›ë¬¸ì´ ì±„ì›Œì ¸ ìˆì–´ìš”. ìˆ˜ì • í›„ ì €ì¥í•˜ë©´ ë²ˆì—­ì´ ìƒì„±ë©ë‹ˆë‹¤.
                        </div>
                    </form>

                </div>
            </div>
        </div>

    </div>
</div>

<th:block th:replace="~{layout/footer :: footer}"></th:block>
<script th:inline="javascript">
    /*<![CDATA[*/
    const hasTranslation = /*[[${translation.id != null}]]*/ false;
    const initialContent = /*[[${translation.id == null ? article.content : translation.content}]]*/ "";

    const formEl = document.getElementById('translationForm');

    const editBtn = document.getElementById('editBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveProxyBtn');

    const viewDiv = document.getElementById('translatedContentView');
    const editorWrap = document.getElementById('translatedContentEditorWrap');
    const editorTa = document.getElementById('translatedContentEditor');

    const contentHidden = document.getElementById('contentHidden');
    const lockHint = document.getElementById('lockHint');

    let originalHtmlForCancel = '';
    let sn = null; // app.js initSummernote ë°˜í™˜ api

    // âœ… ê¸°ì¡´ ë²ˆì—­ì¼ ë•Œ: ì…ë ¥ ì ê¸ˆ + ì €ì¥ ë¹„í™œì„±
    function lockFields() {
        // title/author/description/summary ë“± readonlyë¡œ ë§Œë“¤ê¸°
        const lockTargets = formEl.querySelectorAll('#translationSection input, #translationSection textarea');
        lockTargets.forEach(el => el.setAttribute('readonly', 'readonly'));
        if (saveBtn) saveBtn.disabled = true;
        if (lockHint) lockHint.classList.remove('d-none');
    }

    // âœ… ìˆ˜ì • ëª¨ë“œì¼ ë•Œ: ì ê¸ˆ í•´ì œ + ì €ì¥ í™œì„±
    function unlockFields() {
        const lockTargets = formEl.querySelectorAll('#translationSection input, #translationSection textarea');
        lockTargets.forEach(el => el.removeAttribute('readonly'));
        if (saveBtn) saveBtn.disabled = false;
        if (lockHint) lockHint.classList.add('d-none');
    }

    function destroySummernote() {
        if (sn) {
            sn.destroy();
            sn = null;
        }
        if (editorTa) editorTa.style.display = 'none';
        if (editorWrap) editorWrap.style.display = 'none';
        if (viewDiv) viewDiv.style.display = 'block';
    }

    function enterEditMode({ showCancelBtn = true } = {}) {
        // ì·¨ì†Œë¥¼ ìœ„í•œ ì›ë³¸ ìŠ¤ëƒ…ìƒ·
        originalHtmlForCancel = viewDiv?.innerHTML || initialContent || '';
        if (contentHidden) contentHidden.value = originalHtmlForCancel;

        unlockFields();

        if (viewDiv) viewDiv.style.display = 'none';
        if (editorWrap) editorWrap.style.display = 'block';
        if (editorTa) editorTa.style.display = 'block';

        // âœ… postì™€ ë™ì¼í•˜ê²Œ app.jsì˜ initSummernote ì‚¬ìš©
        sn = window.initSummernote({
            selector: '#translatedContentEditor',
            existingContent: originalHtmlForCancel,
            height: 320,
            contentHiddenSelector: '#contentHidden'
        });

        if (editBtn) editBtn.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = showCancelBtn ? 'inline-block' : 'none';
    }

    function enterViewMode() {
        // ë‚´ìš© ë˜ëŒë¦¬ê¸°
        if (viewDiv) viewDiv.innerHTML = originalHtmlForCancel;
        if (contentHidden) contentHidden.value = originalHtmlForCancel;

        destroySummernote();

        // ë‹¤ì‹œ ì ê¸ˆ
        lockFields();

        if (editBtn) editBtn.style.display = hasTranslation ? 'inline-block' : 'none';
        if (cancelBtn) cancelBtn.style.display = 'none';
    }

    async function doSave() {
        // ê¸°ì¡´ ë²ˆì—­ì¸ë° ì ê¸ˆì´ë©´ ì €ì¥ ë§‰ê¸°
        if (hasTranslation && saveBtn && saveBtn.disabled) return;

        let content = '';
        let files = [];

        if (sn) {
            const payload = window.getSummernotePayload({
                editorSelector: '#translatedContentEditor',
                contentHiddenSelector: '#contentHidden'
            });
            content = payload.content;
            files = payload.files;
        } else {
            // ì‹ ê·œì¸ë° snì´ ì—†ëŠ” ì˜ˆì™¸ ì¼€ì´ìŠ¤ ë°©ì–´
            content = viewDiv?.innerHTML || initialContent || '';
        }

        if (contentHidden) contentHidden.value = content;

        const fd = new FormData(formEl);

        // contentëŠ” hidden í•˜ë‚˜ë§Œ ìœ ì§€
        fd.delete('content');
        fd.append('content', content);

        // editorì—ì„œ ëª¨ì€ ì´ë¯¸ì§€ íŒŒì¼ ì¶”ê°€
        for (const f of files) fd.append('files', f);

        try {
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.dataset._txt = saveBtn.textContent;
                saveBtn.textContent = 'ì €ì¥ ì¤‘...';
            }

            const res = await fetch(formEl.action, { method: 'POST', body: fd });

            // ì„œë²„ê°€ redirect ì£¼ë©´ ê·¸ìª½ìœ¼ë¡œ
            if (res.redirected) { window.location.href = res.url; return; }

            // OKë©´ reload (ê¸°ì¡´ íŒ¨í„´ ìœ ì§€)
            if (res.ok) { window.location.reload(); return; }

            throw new Error('ì €ì¥ ì‹¤íŒ¨: ' + res.status + ' ' + await res.text());
        } catch (e) {
            console.error(e);
            alert(e?.message ?? e);
            if (saveBtn) saveBtn.disabled = false;
        } finally {
            if (saveBtn && saveBtn.dataset._txt) {
                saveBtn.textContent = saveBtn.dataset._txt;
                delete saveBtn.dataset._txt;

                // ê¸°ì¡´ ë²ˆì—­ + ë·°ëª¨ë“œë©´ ì €ì¥ ë¹„í™œì„± ìœ ì§€
                if (hasTranslation && !sn) saveBtn.disabled = true;
                else saveBtn.disabled = false;
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // content hidden ì´ˆê¸°ê°’ ë°©ì–´
        if (contentHidden && !contentHidden.value) contentHidden.value = initialContent;

        if (hasTranslation) {
            // âœ… ê¸°ì¡´ ë²ˆì—­: ì ê¸ˆ + previewë§Œ
            lockFields();
            if (editBtn) editBtn.style.display = 'inline-block';
            if (cancelBtn) cancelBtn.style.display = 'none';

            if (viewDiv) viewDiv.style.display = 'block';
            if (editorWrap) editorWrap.style.display = 'none';
            destroySummernote();
        } else {
            // âœ… ì‹ ê·œ ë²ˆì—­: ë°”ë¡œ edit ëª¨ë“œ
            unlockFields();
            if (editBtn) editBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
            if (viewDiv) viewDiv.style.display = 'none';

            enterEditMode({ showCancelBtn: false });
        }

        editBtn?.addEventListener('click', () => enterEditMode({ showCancelBtn: true }));
        cancelBtn?.addEventListener('click', enterViewMode);
        saveBtn?.addEventListener('click', doSave);

        // ì—”í„° submit ë°©ì§€
        formEl?.addEventListener('submit', (e) => e.preventDefault());
    });
    /*]]>*/
</script>

</body>
</html>
