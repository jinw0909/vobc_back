<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout/head :: head}"></th:block>

<body class="bg-light">
<th:block th:replace="~{layout/header :: header}"></th:block>
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="m-0">기사 목록</h2>
    <a class="btn btn-primary" th:href="@{/article/create}">
      <i class="fa-solid fa-pen-to-square me-1"></i> 새 글
    </a>
  </div>

  <!-- ✅ Search: Keyword + Date (통합 /article/search) -->
  <div class="card mb-3">
    <div class="card-body">
      <form method="get" th:action="@{/article/search}" id="searchForm">
        <div class="row g-2 align-items-end">

          <!-- 🔎 Keyword -->
          <div class="col-12 col-lg-6">
            <label class="form-label small text-muted mb-1">키워드 (제목/본문)</label>
            <input type="text"
                   class="form-control"
                   name="keyword"
                   placeholder="키워드를 입력하세요"
                   th:value="${q}">
          </div>

          <div class="col-12 col-lg-4">
            <label class="form-label small text-muted mb-1">퍼블리셔</label>
            <input type="text"
                   class="form-control"
                   name="publisher"
                   placeholder="퍼블리셔 이름"
                   th:value="${publisher}">
          </div>


          <!-- 📅 Date Range -->
          <div class="col-6 col-lg-3">
            <label class="form-label small text-muted mb-1">시작일</label>
            <input type="date"
                   class="form-control"
                   name="startDate"
                   th:value="${startDate != null ? #temporals.format(startDate, 'yyyy-MM-dd') : ''}">
          </div>

          <div class="col-6 col-lg-3">
            <label class="form-label small text-muted mb-1">종료일</label>
            <input type="date"
                   class="form-control"
                   name="endDate"
                   th:value="${endDate != null ? #temporals.format(endDate, 'yyyy-MM-dd') : ''}">
          </div>

          <!-- ✅ Buttons (하나씩만) -->
          <div class="col-12 d-flex flex-wrap gap-2 mt-2">
            <button class="btn btn-outline-primary" type="submit">
              검색
            </button>

            <!-- 입력만 비우기: 페이지 이동 X -->
            <button class="btn btn-outline-secondary" type="button" id="clearInputsBtn">
              입력 비우기
            </button>

            <!-- 전체 초기화: 검색 해제하고 목록으로 -->
            <a class="btn btn-outline-dark" th:href="@{/article/list}">
              전체 초기화
            </a>
          </div>

        </div>
      </form>

      <!-- ✅ 현재 검색 상태 표시 -->
      <div class="mt-3 small text-muted"
           th:with="hasKeyword=${q != null and !#strings.isEmpty(q)},
                  hasDate=${startDate != null or endDate != null}">
      <span th:if="${hasKeyword or hasDate}">
        현재:
        <span th:if="${hasKeyword}">
          키워드 <strong th:text="${q}">keyword</strong>
        </span>
        <span th:if="${hasKeyword and hasDate}"> / </span>
        <span th:if="${hasDate}">
          날짜
          <strong th:text="${startDate != null ? #temporals.format(startDate, 'yyyy-MM-dd') : '-'}">start</strong>
          ~
          <strong th:text="${endDate != null ? #temporals.format(endDate, 'yyyy-MM-dd') : '-'}">end</strong>
        </span>
      </span>

        <span th:if="${!(hasKeyword or hasDate)}">
        현재: 전체 목록
      </span>
      </div>

    </div>
  </div>


  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
        <tr>
          <th style="width: 90px;">ID</th>
          <th>제목</th>
          <th style="width: 220px;">퍼블리셔</th>
          <th style="width: 140px;">카테고리</th>
          <th style="width: 140px;">출시일</th>
          <th style="width: 160px;">작업</th>
        </tr>
        </thead>

        <tbody>
        <tr th:if="${#lists.isEmpty(articles)}">
          <td colspan="6" class="text-center text-muted py-5">
            아직 기사가 없습니다.
          </td>
        </tr>

        <tr th:each="a : ${articles}">
          <td class="text-muted" th:text="${a.id}">1</td>

          <td>
            <div class="fw-semibold">
              <a th:href="@{/article/detail(id=${a.id})}" th:text="${a.title}">제목</a>
            </div>

            <div class="text-muted small"
                 th:if="${a.summary != null and !#strings.isEmpty(a.summary)}"
                 th:text="${#strings.abbreviate(a.summary, 80)}">
              요약...
            </div>
          </td>

          <td>
            <span class="text-muted" th:if="${a.publisher == null}">-</span>
            <span th:if="${a.publisher != null}" th:text="${a.publisher.name}">Publisher Name</span>
          </td>

          <td>
            <span class="badge text-bg-secondary"
                  th:if="${a.category != null}"
                  th:text="${a.category.type}">news</span>
            <span class="text-muted" th:if="${a.category == null}">-</span>
          </td>

          <td>
            <span class="text-muted" th:if="${a.releaseDate == null}">-</span>
            <span th:if="${a.releaseDate != null}"
                  th:text="${#temporals.format(a.releaseDate, 'yyyy-MM-dd')}">2025-12-19</span>
          </td>

          <td class="text-nowrap">
            <a class="btn btn-sm btn-outline-primary"
               th:href="@{/article/detail(id=${a.id})}">
              보기
            </a>
            <a class="btn btn-sm btn-outline-secondary"
               th:href="@{/article/edit(id=${a.id})}">
              수정
            </a>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ✅ Pagination (검색 파라미터 유지) -->
  <nav class="mt-4" th:if="${page != null and page.totalPages > 1}" aria-label="Pagination">
    <ul class="pagination justify-content-center mb-0">

      <!-- Prev -->
      <li class="page-item" th:classappend="${page.first} ? 'disabled'">
        <a class="page-link"
           th:href="@{/article/search(
                      page=${page.number - 1},
                      size=${page.size},
                      keyword=${q},
                      publisher=${publisher},
                      startDate=${startDate},
                      endDate=${endDate}
                    )}"
           aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>

      <!-- Page Numbers -->
      <li class="page-item"
          th:each="i : ${#numbers.sequence(T(java.lang.Math).max(0, page.number - 2), T(java.lang.Math).min(page.totalPages - 1, page.number + 2))}"
          th:classappend="${i == page.number} ? 'active'">
        <a class="page-link"
           th:href="@{/article/search(
                      page=${i},
                      size=${page.size},
                      keyword=${q},
                      publisher=${publisher},
                      startDate=${startDate},
                      endDate=${endDate}
                    )}"
           th:text="${i + 1}">1</a>
      </li>

      <!-- Next -->
      <li class="page-item" th:classappend="${page.last} ? 'disabled'">
        <a class="page-link"
           th:href="@{/article/search(
                      page=${page.number + 1},
                      size=${page.size},
                      keyword=${q},
                      publisher=${publisher},
                      startDate=${startDate},
                      endDate=${endDate}
                    )}"
           aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>

    </ul>

    <div class="text-center text-muted small mt-2">
      <span th:text="'총 ' + ${page.totalElements} + '건 · ' + (${page.number} + 1) + '/' + ${page.totalPages} + ' 페이지'">
        총 0건 · 1/1 페이지
      </span>
    </div>
  </nav>

</div>
<script>
  (function () {
    const btn = document.getElementById('clearInputsBtn');
    const form = document.getElementById('searchForm');
    if (!btn || !form) return;

    btn.addEventListener('click', () => {
      // input만 비우기 (페이지 이동 X)
      form.querySelectorAll('input[name="keyword"], input[name="startDate"], input[name="endDate"]').forEach(el => {
        el.value = '';
      });
      // UX: 키워드 입력칸 포커스
      const keyword = form.querySelector('input[name="keyword"]');
      if (keyword) keyword.focus();
    });
  })();
</script>
<th:block th:replace="~{layout/footer :: footer}"></th:block>
</body>
</html>
