<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout/head :: head}"></th:block>

<body>
<th:block th:replace="~{layout/header :: header}"></th:block>

<main class="container py-4">

  <!-- Header -->
  <div class="d-flex align-items-start justify-content-between mb-3">
    <div>
      <div class="d-flex align-items-center gap-2 mb-1">
        <span class="badge text-bg-secondary" th:text="${form.termCode}">CODE</span>
        <span class="text-muted small">#<span th:text="${form.termId}">1</span></span>
        <span class="badge text-bg-info"
              th:text="${translationForm != null && translationForm.languageCode != null
                ? #strings.toUpperCase(translationForm.languageCode.code)
                : 'EN'}">
          EN
        </span>
      </div>

      <h1 class="h4 mb-1">번역 관리</h1>

      <div class="text-muted small">
        Propose Date:
        <span th:text="${form.proposeDate}">2025-12-16</span>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary"
         th:href="@{/term/detail(id=${form.termId})}">
        상세로
      </a>
    </div>
  </div>

  <div class="row g-3">
    <!-- Original (read-only) -->
    <div class="col-lg-6">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">원문</h2>
            <span class="badge text-bg-light border">Read-only</span>
          </div>

          <div class="mb-3">
            <label class="form-label">Title</label>
            <div class="form-control bg-light" th:text="${form.title}">Original title...</div>
          </div>

          <!-- 원문 Content: Text/HTML 탭 -->
          <label class="form-label">Content</label>
          <ul class="nav nav-tabs" id="originalContentTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="orig-text-tab"
                      data-bs-toggle="tab" data-bs-target="#orig-text-pane"
                      type="button" role="tab">
                Text
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="orig-html-tab"
                      data-bs-toggle="tab" data-bs-target="#orig-html-pane"
                      type="button" role="tab">
                HTML
              </button>
            </li>
          </ul>

          <div class="tab-content border border-top-0 rounded-bottom p-3 bg-light">
            <div class="tab-pane fade show active" id="orig-text-pane" role="tabpanel">
              <div style="white-space: pre-wrap;" th:text="${form.content}">Original content...</div>
            </div>
            <div class="tab-pane fade" id="orig-html-pane" role="tabpanel">
              <!-- ⚠️ 원문이 신뢰된 HTML일 때만 utext -->
              <div th:utext="${form.content}">Original HTML...</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Translation (view -> edit) -->
    <div class="col-lg-6">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">

          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h5 mb-0">번역</h2>

            <!-- 존재 여부 뱃지 -->
            <span class="badge"
                  th:classappend="${translationForm != null && translationForm.id != null
                    ? ' text-bg-success'
                    : ' text-bg-warning'}"
                  th:text="${translationForm != null && translationForm.id != null
                    ? 'EXISTS'
                    : 'NEW'}">
              EXISTS
            </span>
          </div>

          <p class="text-muted small mb-3">
            <span th:if="${translationForm != null && translationForm.id != null}">
              기존 번역이 존재합니다. <strong>수정</strong> 버튼을 눌러 편집 후 저장하세요.
            </span>
            <span th:if="${translationForm == null || translationForm.id == null}">
              해당 언어 번역이 없습니다. 내용을 입력하고 <strong>등록</strong> 버튼으로 저장하세요.
            </span>
          </p>

          <!-- 저장/수정 공통: /add-translation -->
          <form th:action="@{/term/add-translation}" method="post" class="vstack gap-3" id="translationForm">

            <!-- termId / languageCode는 반드시 함께 전송 -->
            <input type="hidden" name="termId" th:value="${form.termId}" />

            <!-- languageCode -->
            <input type="hidden" name="languageCode"
                   th:value="${translationForm != null && translationForm.languageCode != null
                     ? translationForm.languageCode.code
                     : 'en'}" />

            <!-- 번역 id가 있으면 같이 보내도 됨(업서트 로직이 id 기반이면) -->
            <input type="hidden" name="id"
                   th:value="${translationForm != null ? translationForm.id : ''}" />

            <div>
              <label class="form-label">Language</label>
              <div class="form-control bg-light"
                   th:text="${translationForm != null && translationForm.languageCode != null
                     ? #strings.toUpperCase(translationForm.languageCode.code)
                     : 'EN'}">
                EN
              </div>
              <div class="form-text">언어는 이 페이지에서 변경할 수 없습니다.</div>
            </div>

            <div>
              <label class="form-label">Translated Title</label>
              <input class="form-control js-editable"
                     type="text"
                     name="title"
                     th:value="${translationForm != null ? translationForm.title : ''}"
                     th:attr="readonly=${translationForm != null && translationForm.id != null}" />
            </div>

            <div>
              <label class="form-label">Translated Content</label>
              <textarea class="form-control js-editable"
                        name="content" rows="10"
                        th:text="${translationForm != null ? translationForm.content : ''}"
                        th:attr="readonly=${translationForm != null && translationForm.id != null}"></textarea>
            </div>

            <div class="d-flex gap-2 pt-2">
              <!-- EXISTS면: 수정 버튼(편집모드 전환) + 저장 버튼(처음엔 disabled) -->
              <button type="button"
                      class="btn btn-outline-dark"
                      id="btnEdit"
                      th:if="${translationForm != null && translationForm.id != null}">
                수정
              </button>

              <button type="submit"
                      class="btn btn-primary"
                      id="btnSave"
                      th:text="${translationForm != null && translationForm.id != null ? '저장' : '등록'}"
                      th:attr="disabled=${translationForm != null && translationForm.id != null}">
                저장
              </button>



              <a class="btn btn-outline-secondary"
                 th:href="@{/term/detail(id=${form.termId})}">
                취소
              </a>
            </div>

            <div class="form-text" th:if="${translationForm != null && translationForm.id != null}">
              수정 버튼을 누르면 입력창이 활성화되고 저장 버튼이 활성화됩니다.
            </div>

          </form>

          <form th:if="${translationForm != null && translationForm.id != null}"
                th:action="@{/term/remove-translation}"
                method="post"
                class="mt-3"
                onsubmit="return confirm('정말 이 번역을 삭제하시겠습니까?');">

            <input type="hidden" name="termId" th:value="${form.termId}" />
            <input type="hidden" name="lang"
                   th:value="${translationForm.languageCode != null ? translationForm.languageCode.code : 'en'}" />
            <input type="hidden" name="translationId" th:value="${translationForm.id}" />

            <button type="submit" class="btn btn-danger w-100">
              번역 삭제
            </button>
          </form>

        </div>
      </div>
    </div>
  </div>

</main>

<th:block th:replace="~{layout/footer :: footer}"></th:block>

<!-- 간단한 편집모드 토글 스크립트 -->
<script>
  (function () {
    const btnEdit = document.getElementById('btnEdit');
    const btnSave = document.getElementById('btnSave');
    const editable = document.querySelectorAll('.js-editable');

    if (!btnEdit) return;

    btnEdit.addEventListener('click', function () {
      editable.forEach(el => {
        el.removeAttribute('readonly');
        el.focus();
      });
      btnSave.removeAttribute('disabled');
      btnEdit.setAttribute('disabled', 'disabled');
    });
  })();
</script>

</body>
</html>
