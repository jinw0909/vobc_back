<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<th:block th:replace="~{layout/head :: head}"></th:block>

<style>
    .container { max-width: 980px; margin: 0 auto; }
    .header {
        display:flex; justify-content:space-between; align-items:flex-start;
        gap:12px; margin:20px 0;
    }
    .title-wrap { display:flex; flex-direction:column; gap:6px; }
    .subtitle { color:#666; font-size:.95rem; }

    .btns { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .btn {
        padding:8px 14px; border-radius:6px; text-decoration:none; border:1px solid transparent;
        cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
        font-size:.95rem; line-height:1; height:34px; box-sizing:border-box;
    }
    .btn-primary { background:#222; color:#fff; }
    .btn-secondary { background:#fff; color:#111; border-color:#ddd; }
    .btn-danger { background:#c62828; color:#fff; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .card {
        border:1px solid #e5e5e5; border-radius:12px; padding:16px; background:#fff;
    }
    .card h3 { margin:0 0 12px 0; font-size:1.05rem; }
    .muted { color:#666; font-size:.95rem; }

    .field { margin-bottom:14px; }
    label { display:block; font-weight:700; margin-bottom:6px; color:#333; }
    input[type="text"], textarea {
        width:100%; padding:10px; box-sizing:border-box;
        border:1px solid #ddd; border-radius:8px; outline:none;
    }
    textarea { min-height: 110px; resize: vertical; }

    .row {
        display:grid; grid-template-columns:140px 1fr; gap:10px;
        padding:10px 0; border-bottom:1px solid #f0f0f0;
    }
    .row:last-child { border-bottom:none; }

    /* 기존 .thumb 대신 */
    .thumb-bg{
        width:44px; height:44px; border-radius:10px;
        border:1px solid #e5e5e5;
        display:flex; align-items:center; justify-content:center;
        overflow:hidden;
    }

    /* 배경 분리 */
    .thumb-bg.dark { background:#111; }
    .thumb-bg.light { background:#fff; }

    /* 실제 이미지 */
    .thumb-img{
        width:100%; height:100%;
        object-fit:contain;   /* cover 말고 contain이 아이콘에 더 자연스러움 */
        display:block;
    }


    .icon-preview-wrap { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip {
        display:inline-flex; align-items:center; gap:8px;
        padding:6px 10px; border:1px solid #eee; border-radius:999px; background:#fff;
        font-size:.9rem; color:#333;
    }
    .chip .dot {
        width:10px; height:10px; border-radius:50%;
        background:#111;
    }
    .chip.light .dot { background:#fff; border:1px solid #ccc; }

    .member-toolbar {
        display:flex; gap:10px; flex-wrap:wrap;
        align-items:center; justify-content:space-between;
        margin-bottom:12px;
    }
    .member-toolbar .left { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill {
        padding:6px 10px; border-radius:999px; background:#f6f6f6; border:1px solid #eee;
        font-size:.9rem; color:#333;
    }

    .member-list { display:flex; flex-direction:column; gap:8px; }
    .member-item {
        display:flex; align-items:center; gap:10px;
        border:1px solid #f0f0f0; border-radius:10px; padding:10px;
        background:#fff;
    }
    .member-photo {
        width:40px; height:40px; border-radius:10px; object-fit:cover;
        border:1px solid #eee; background:#fafafa; flex:0 0 auto;
    }
    .member-meta { display:flex; flex-direction:column; gap:2px; min-width:0; }
    .member-name { font-weight:700; color:#111; }
    .member-role {
        color:#666; font-size:.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .member-check { margin-left:auto; transform:scale(1.1); }

    .pager { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:12px; }
    .pager .btn { height:32px; padding:6px 12px; font-size:.9rem; }
    .pager .pageinfo { color:#666; font-size:.9rem; }

    .actions {
        margin-top:16px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }

    .alert {
        border:1px solid #eee; border-radius:10px; padding:12px; background:#fafafa;
        margin-bottom:14px;
    }
</style>

<body>
<th:block th:replace="~{layout/header :: header}"></th:block>

<div class="container">

    <div class="header">
        <div class="title-wrap">
            <h1 th:text="|Edit Team (#${form.id})|">Edit Team</h1>
            <div class="subtitle">팀 정보 수정 + 기존 멤버 연결/해제</div>
        </div>

        <div class="btns">
            <a class="btn btn-secondary" th:href="@{/team/{id}(id=${form.id})}">Back</a>
            <a class="btn btn-secondary" th:href="@{/team/list}">Team List</a>
        </div>
    </div>

    <div class="grid">
        <!-- LEFT: Team form -->
        <div class="card">
            <h3>Team Info</h3>

            <div class="alert muted">
                오른쪽 목록에서 체크한 멤버들이 이 팀에 연결돼요. 저장하면 반영됩니다.
            </div>

            <form id="teamEditForm"
                  th:action="@{/team/{teamId}/edit(teamId=${form.id})}"
                  method="post"
                  th:object="${form}">

                <!-- id -->
                <input type="hidden" th:field="*{id}"/>

                <div class="field">
                    <label for="name">Name</label>
                    <input id="name" type="text" th:field="*{name}" required>
                </div>

                <div class="field">
                    <label for="description">Description</label>
                    <textarea id="description" th:field="*{description}"></textarea>
                </div>

                <div class="field">
                    <label for="iconFile">Upload Icon</label>
                    <input id="iconFile" type="file" accept="image/*">
                    <div class="muted" style="margin-top:6px;">
                        업로드하면 자동으로 S3에 저장되고 icon URL이 세팅됩니다.
                    </div>
                </div>


                <div class="field">
                    <label for="icon">Icon URL</label>
                    <input id="icon" type="text" th:field="*{icon}" placeholder="https://...">
                    <div class="muted" style="margin-top:6px;">
                        아이콘 URL을 넣으면 아래 미리보기가 갱신돼요.
                    </div>
                </div>

                <!-- Icon preview (black/white bg) -->
                <div class="row" style="margin-top:10px;">
                    <div class="label">Icon Preview</div>
                    <div class="value">
                        <div class="icon-preview-wrap">
                          <span class="chip">
                              <span class="dot" title="dark bg"></span>
                              <span class="thumb-bg dark">
                                <img class="thumb-img" id="iconPreviewDark" alt="icon on dark"/>
                              </span>
                            </span>

                            <span class="chip light">
                              <span class="dot" title="white bg"></span>
                              <span class="thumb-bg light">
                                <img class="thumb-img" id="iconPreviewLight" alt="icon on light"/>
                              </span>
                            </span>
                            <span class="muted" id="iconPreviewEmpty">아이콘이 없으면 표시되지 않아요.</span>
                        </div>
                    </div>
                </div>

                <!-- ✅ members[*].id hidden inputs go here -->
                <div id="membersContainer"></div>

                <div class="actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <a class="btn btn-secondary" th:href="@{/team/{id}(id=${form.id})}">Cancel</a>
                </div>
            </form>
        </div>

        <!-- RIGHT: Member picker -->
        <div class="card">
            <h3>Members</h3>

            <div class="member-toolbar">
                <div class="left">
                    <span class="pill">Selected: <b id="selectedCount">0</b></span>
                    <button type="button" class="btn btn-secondary" id="clearBtn">Clear</button>
                </div>
                <div class="muted">
                    목록은 API로 불러옵니다.
                </div>
            </div>

            <div id="memberList" class="member-list"></div>

            <div class="pager">
                <button type="button" class="btn btn-secondary" id="prevBtn">Prev</button>
                <span class="pageinfo" id="pageInfo">1 / 1</span>
                <button type="button" class="btn btn-secondary" id="nextBtn">Next</button>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{layout/footer :: footer}"></th:block>

<script th:inline="javascript">
    /*<![CDATA[*/
    // ✅ 서버에서 내려준 초기 선택 id들
    const initialSelectedIds = /*[[${selectedIds}]]*/ [];
    const apiUrl = '/team/member/api/allmembers';

    // selection state
    const selected = new Set((initialSelectedIds || []).map(Number));

    // paging state
    let page = 0;
    const size = 10;
    let totalPages = 1;

    const memberListEl = document.getElementById('memberList');
    const selectedCountEl = document.getElementById('selectedCount');
    const membersContainer = document.getElementById('membersContainer');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    const clearBtn = document.getElementById('clearBtn');

    // icon preview
    const iconInput = document.getElementById('icon');
    const iconPreviewDark = document.getElementById('iconPreviewDark');
    const iconPreviewLight = document.getElementById('iconPreviewLight');
    const iconPreviewEmpty = document.getElementById('iconPreviewEmpty');

    const formEl = document.getElementById('teamEditForm');

    function updateSelectedCount() {
        selectedCountEl.textContent = String(selected.size);
    }

    // ✅ 핵심: TeamForm.members 바인딩을 위해 members[i].id hidden 생성
    function syncMembersHiddenInputs() {
        membersContainer.innerHTML = '';

        const ids = [...selected];

        // members[0].id, members[1].id ...
        ids.forEach((id, idx) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `members[${idx}].id`;
            input.value = String(id);
            membersContainer.appendChild(input);
        });
    }

    function applyIconPreview(url) {
        const has = url && url.trim().length > 0;

        if (!has) {
            iconPreviewDark.style.display = 'none';
            iconPreviewLight.style.display = 'none';
            iconPreviewEmpty.style.display = 'inline';
            return;
        }

        iconPreviewDark.src = url;
        iconPreviewLight.src = url;
        iconPreviewDark.style.display = 'block';
        iconPreviewLight.style.display = 'block';
        iconPreviewEmpty.style.display = 'none';
    }

    async function fetchPage(p) {
        const res = await fetch(`${apiUrl}?page=${p}&size=${size}`, {
            headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) throw new Error(await res.text());
        return await res.json(); // Spring Page JSON
    }

    function renderMemberItem(m) {
        const wrapper = document.createElement('div');
        wrapper.className = 'member-item';

        const img = document.createElement('img');
        img.className = 'member-photo';
        img.alt = 'member photo';
        img.src = (m.photo && m.photo.length > 0) ? m.photo : '/img/fallback.png';

        const meta = document.createElement('div');
        meta.className = 'member-meta';

        const name = document.createElement('div');
        name.className = 'member-name';
        name.textContent = m.name ?? `#${m.id}`;

        const role = document.createElement('div');
        role.className = 'member-role';
        role.textContent = m.role ?? '';

        meta.appendChild(name);
        if (role.textContent.trim().length > 0) meta.appendChild(role);

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.className = 'member-check';

        const id = Number(m.id);
        chk.checked = selected.has(id);

        chk.addEventListener('change', () => {
            if (chk.checked) selected.add(id);
            else selected.delete(id);

            updateSelectedCount();
            syncMembersHiddenInputs();
        });

        wrapper.appendChild(img);
        wrapper.appendChild(meta);
        wrapper.appendChild(chk);

        return wrapper;
    }

    async function renderList() {
        memberListEl.innerHTML = '<div class="muted">로딩 중...</div>';

        try {
            const data = await fetchPage(page);
            totalPages = Math.max(data.totalPages ?? 1, 1);

            memberListEl.innerHTML = '';
            const content = data.content ?? [];

            if (content.length === 0) {
                memberListEl.innerHTML = '<div class="muted">멤버가 없습니다.</div>';
            } else {
                content.forEach(m => memberListEl.appendChild(renderMemberItem(m)));
            }

            pageInfo.textContent = `${page + 1} / ${totalPages}`;
            prevBtn.disabled = (page <= 0);
            nextBtn.disabled = (page + 1 >= totalPages);

        } catch (e) {
            console.error(e);
            memberListEl.innerHTML = `<div class="muted">불러오기 실패: ${e.message}</div>`;
            pageInfo.textContent = ' - ';
            prevBtn.disabled = true;
            nextBtn.disabled = true;
        }
    }

    prevBtn.addEventListener('click', async () => {
        if (page <= 0) return;
        page--;
        await renderList();
    });

    nextBtn.addEventListener('click', async () => {
        if (page + 1 >= totalPages) return;
        page++;
        await renderList();
    });

    clearBtn.addEventListener('click', async () => {
        selected.clear();
        updateSelectedCount();
        syncMembersHiddenInputs();
        await renderList(); // 현재 페이지 체크 UI 갱신
    });

    // ✅ 혹시라도 저장 전에 hidden 갱신이 안 됐을 수 있으니 submit 직전에 한번 더 sync
    formEl.addEventListener('submit', () => {
        syncMembersHiddenInputs();
    });

    document.addEventListener('DOMContentLoaded', async () => {
        // 초기 상태
        updateSelectedCount();
        syncMembersHiddenInputs();

        // icon preview init
        applyIconPreview(iconInput?.value || '');
        iconInput?.addEventListener('input', (e) => applyIconPreview(e.target.value));

        await renderList();
    });
    /*]]>*/
</script>
<script>
    const iconFileInput = document.getElementById('iconFile');

    iconFileInput?.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch('/api/upload/thumbnail', {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error(await res.text());

            const data = await res.json(); // { url: "..." }
            const url = data.url;

            // icon input에 세팅
            iconInput.value = url;

            // 미리보기 갱신
            applyIconPreview(url);

        } catch (err) {
            console.error(err);
            alert('아이콘 업로드 실패');
        }
    });

</script>
</body>
</html>
